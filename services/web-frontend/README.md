# Web Frontend Service

Этот документ описывает сервис веб-фронтенда для Bomberman Online. Он предоставляет пользовательский интерфейс для взаимодействия с игрой, включая регистрацию/вход, создание и присоединение к играм, игровую сессию и просмотр статистики.

## 1. Назначение сервиса

`Web Frontend` является основным клиентским приложением, через которое пользователи взаимодействуют с платформой Bomberman Online. Его основные функции включают:

*   **Аутентификация и авторизация**: Регистрация новых пользователей, вход в систему, сброс пароля и верификация электронной почты.
*   **Управление игровыми сессиями**: Просмотр списка доступных игр, создание новых игровых комнат с различными настройками, присоединение к существующим играм.
*   **Игровой процесс**: Отображение игрового поля в реальном времени, обработка ввода игрока (движение, использование оружия), взаимодействие с игровыми сущностями.
*   **Редактор карт**: Инструмент для создания и редактирования пользовательских карт.
*   **Профиль пользователя и статистика**: Просмотр и редактирование профиля, отображение игровой статистики.

## 2. Используемые технологии

Проект построен на современном стеке веб-разработки:

*   **React**: Библиотека для создания пользовательских интерфейсов.
*   **TypeScript**: Типизированный надмножество JavaScript для повышения надежности и поддерживаемости кода.
*   **Material-UI (MUI)**: Библиотека React-компонентов, реализующая Material Design для стилизации и быстрого прототипирования UI.
*   **Axios**: HTTP-клиент для взаимодействия с RESTful API.
*   **Socket.IO Client**: Клиентская библиотека для работы с WebSocket-соединениями, используемая для реального времени игровых обновлений.
*   **Formik & Yup**: Для управления формами и валидации данных.
*   **Webpack**: Сборщик модулей для сборки и оптимизации фронтенд-ресурсов.
*   **Babel**: Транспайлер для преобразования современного JavaScript/TypeScript в совместимый со старыми браузерами код.
*   **Loglevel**: Легкая библиотека для логирования на клиенте.

## 3. Пользовательские маршруты (Pages)

Корневой компонент `src/App.tsx` определяет основную структуру маршрутизации приложения. Папка `src/pages` содержит компоненты-страницы, которые используются в этих маршрутах:

*   `src/App.tsx`: Корневой компонент приложения, настраивает основную маршрутизацию с использованием `react-router-dom`.

### Основные маршруты:

*   `GET /`: Домашняя страница (`Home.tsx`). Доступна всем пользователям.
*   `GET /account/game/:gameId`: Страница игровой сессии (`Game.tsx`). Требует аутентификации.

### Маршруты вложенные в `/account` (используют `Layout.tsx`):

#### Публичные маршруты (доступны только неавторизованным пользователям):
*   `GET /account/login`: Страница входа в систему (`Login.tsx`).
*   `GET /account/register`: Страница регистрации (`Register.tsx`).
*   `GET /account/reset-password`: Страница запроса сброса пароля (`ResetPassword.tsx`).
*   `GET /account/confirm-reset-password`: Страница подтверждения сброса пароля (`ConfirmResetPassword.tsx`).

#### Общие маршруты:
*   `GET /account/verify-email`: Страница для верификации электронной почты (`VerifyEmail.tsx`). Доступна всем пользователям.

#### Защищенные маршруты (требуют аутентификации):
*   `GET /account/dashboard`: Главная страница после входа, обзор игр, профиля (`Dashboard.tsx`).
*   `GET /account/profile`: Профиль пользователя (`Profile.tsx`).
*   `GET /account/stats`: Статистика игрока (`Stats.tsx`).
*   `GET /account/games/create`: Страница для создания новой игровой комнаты (`CreateGame.tsx`).
*   `GET /account/games/:gameId/manage`: Страница для управления созданной игрой (`ManageGame.tsx`).
*   `GET /account/games`: Список доступных игровых комнат (`GameList.tsx`).
*   `GET /account/maps/editor`: Веб-редактор для создания и редактирования игровых карт (`MapEditor.tsx`).

### Прочие маршруты:
*   `GET *`: Страница 404 для несуществующих маршрутов (`NotFound.tsx`).

## 4. Внутренняя архитектура

`Web Frontend` использует модульную структуру для организации кода:

### 4.1. Компоненты (`src/components`)

Содержит переиспользуемые UI-компоненты и логику, не привязанную к конкретной странице:

*   `Layout.tsx`: Компонент, определяющий общий макет страниц (навигация, футер и т.д.).
*   `ProtectedRoute.tsx`: Компонент-обертка для маршрутов, требующих аутентификации.
*   `PublicRoute.tsx`: Компонент-обертка для маршрутов, доступных только неаутентифицированным пользователям.
*   `GameCanvas.tsx`: Компонент React, содержащий `<canvas>` элемент, на котором отрисовывается игра.
*   `Renderer.ts`: Класс, отвечающий за отрисовку игрового состояния на `GameCanvas` (рисует карты, игроков, врагов, бомбы и т.д.).
*   `GameClient.ts`: Класс, управляющий всей клиентской игровой логикой, включая WebSocket-соединение с `WebAPI Service`, отправку команд игрока и обработку обновлений игрового состояния.

### 4.2. Контексты (`src/context`)

Используется React Context API для глобального состояния:

*   `AuthContext.tsx`: Предоставляет контекст аутентификации, управляя состоянием пользователя (вход/выход, токены) и доступом к функциям API авторизации. Используется для защиты маршрутов и доступа к пользовательским данным.

### 4.3. Сервисы (`src/services`)

Содержит модули для взаимодействия с внешними API и обработки бизнес-логики, не связанной напрямую с UI:

*   `api.ts`: Экземпляр Axios, настроенный для взаимодействия с REST API бэкенд-сервисов (Auth Service, Game Service, WebAPI Service). Управляет перехватом запросов/ответов, добавлением токенов авторизации и обработкой ошибок.
*   `InputHandler.ts`: Отвечает за сбор и отправку пользовательского ввода (нажатия клавиш) в `Game Service` через `GameClient`.
*   `tokenService.ts`: Управляет хранением и обновлением токенов JWT (Access и Refresh токены) в Local Storage, а также их валидацией и отправкой запросов на обновление.

### 4.4. Типы (`src/types`)

Определяет TypeScript интерфейсы и типы данных, используемые во всем приложении, что обеспечивает строгую типизацию и улучшает читаемость кода:

*   `Auth.ts`: Типы, связанные с аутентификацией и авторизацией (например, для токенов, ответов логина).
*   `Game.ts`: Типы для игровых сущностей, состояния игры, настроек игры и т.д.
*   `Map.ts`: Типы для шаблонов карт, групп карт и цепочек карт.
*   `Socket.ts`: Типы для данных, передаваемых через Socket.IO.
*   `User.ts`: Типы для пользовательских данных.
*   `EntitiesParams.ts`: Типы, связанные с параметрами игровых сущностей (размеры, типы).

### 4.5. Утилиты (`src/utils`)

*   `Logger.tsx`: Обёртка для библиотеки `loglevel`, предоставляющая удобные функции логирования.

## 5. Переменные окружения

Фронтенд-сервис использует переменные окружения для настройки подключения к бэкенду и других параметров. Они определяются в `Dockerfile` и могут быть переопределены при запуске контейнера.

| Переменная                     | Описание                                                      | Значение по умолчанию (`Dockerfile`) |
| :----------------------------- | :------------------------------------------------------------ | :---------------------------------- |
| `NODE_ENV`                     | Режим окружения (production/development).                     | `production`                        |
| `LOGS_ENDPOINT`                | Эндпоинт для отправки логов.                                  | `/logs`                             |
| `SERVICE_NAME`                 | Имя сервиса (для логирования).                                 | `web-frontend`                      |
| `SOCKET_URL`                   | Базовый URL для подключения Socket.IO (WebAPI Service).       | `http://localhost`                  |
| `SOCKET_PATH`                  | Путь для Socket.IO соединения.                                | `/socket.io`                        |
| `LOGS_BATCH_SIZE`              | Размер пакета логов для отправки.                             | `10`                                |
| `REACT_APP_SOCKET_URL`         | URL Socket.IO для React-приложения.                           | `http://localhost`                  |
| `REACT_APP_SOCKET_PATH`        | Путь Socket.IO для React-приложения.                          | `/socket.io`                        |
| `REACT_APP_LOGS_ENDPOINT`      | Эндпоинт логов для React-приложения.                          | `/logs`                             |
| `REACT_APP_SERVICE_NAME`       | Имя сервиса для React-приложения.                             | `web-frontend`                      |
| `REACT_APP_LOGS_BATCH_SIZE`    | Размер пакета логов для React-приложения.                     | `10`                                |

Переменные с префиксом `REACT_APP_` доступны в коде React-приложения во время сборки.

## 6. Взаимодействие с другими сервисами

*   **Auth Service**: Фронтенд взаимодействует с `Auth Service` через `api.ts` для аутентификации (вход, регистрация, сброс пароля) и управления профилем пользователя.
*   **WebAPI Service**: Основное взаимодействие для управления игровыми сессиями (создание, присоединение) и для реального времени игровых обновлений через Socket.IO.
*   **Game Service**: Хотя прямое взаимодействие минимально (в основном через `WebAPI Service` и NATS через него), фронтенд получает обновления состояния игры, которые генерирует `Game Service`, и отправляет команды игрока, которые затем обрабатываются `Game Service`.

## 7. Запуск/Развертывание

### 7.1. Локальный запуск (для разработки)

1.  **Установите зависимости**: Убедитесь, что у вас установлен Node.js (версия 18, как указано в `Dockerfile`).
    В директории `services/web-frontend`:
    ```bash
    npm install
    ```
2.  **Запустите приложение**: Используйте скрипт `start`, определенный в `package.json`.
    ```bash
    npm start
    ```
    Приложение будет доступно по адресу `http://localhost:3000` (или другому порту, указанному через переменную окружения `PORT`). Webpack Dev Server автоматически перезагружает приложение при изменениях кода.

### 7.2. Сборка и запуск с использованием Docker

1.  **Сборка Docker-образа**: Перейдите в директорию `services/web-frontend` и выполните:
    ```bash
    docker build -t bomberman-web-frontend .
    ```
2.  **Запуск Docker-контейнера**: Запустите контейнер, убедившись, что все необходимые переменные окружения переданы.
    ```bash
    docker run -p 3000:3000 \\
        -e REACT_APP_SOCKET_URL=http://<webapi_service_host> \\
        -e REACT_APP_LOGS_ENDPOINT=http://<logs_service_host>/logs \\
        bomberman-web-frontend
    ```
    Замените `<webapi_service_host>` и `<logs_service_host>` на актуальные хосты или IP-адреса ваших сервисов WebAPI и логирования (например, Traefik, Kong, или внутренний IP в Docker Compose сети).

### 7.3. С использованием Docker Compose (Рекомендуется)

Для комплексного развертывания со всеми зависимыми сервисами (WebAPI, Auth, NATS и т.д.) рекомендуется использовать корневой `docker-compose.yml` проекта. В нем должны быть настроены соответствующие переменные окружения и зависимости между сервисами.

Пример запуска всех сервисов:
```bash
docker-compose up -d
```
Запуск только `web-frontend` (если определен как сервис):
```bash
docker-compose up -d web-frontend
```

--- 