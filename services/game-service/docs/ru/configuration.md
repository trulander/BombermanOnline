# Конфигурация Game Service

Сервис Игр (Game Service) настраивается как на уровне всего приложения (через переменные окружения), так и на уровне каждой отдельной игровой сессии (при её создании).

## 1. Глобальные настройки сервиса (Переменные окружения)

Эти настройки задаются через переменные окружения и определяют поведение всего сервиса. Файл `.env` (созданный из `.env-example`) используется для их установки.

**Основные переменные окружения:**

| Переменная                     | Описание                                                                 | По умолчанию (`app/config.py`)         |
| :----------------------------- | :----------------------------------------------------------------------- | :------------------------------------- |
| `API_V1_STR`                   | Префикс URL для всех API эндпоинтов V1.                                  | `/games/api/v1`                        |
| `APP_TITLE`                    | Заголовок приложения (используется в Swagger).                           | `Bomberman Game Service`               |
| `HOST`                         | Хост, на котором запускается FastAPI приложение.                         | `0.0.0.0`                              |
| `PORT`                         | Порт, на котором запускается FastAPI приложение.                         | `5002`                                 |
| `DEBUG`                        | Включает режим отладки FastAPI.                                          | `True`                                 |
| `RELOAD`                       | Включает автоматическую перезагрузку Uvicorn при изменениях кода.        | `True`                                 |
| `SWAGGER_URL`                  | URL для доступа к Swagger UI документации.                               | `/games/docs`                          |
| `CORS_ORIGINS`                 | Список разрешенных источников для CORS (через запятую или JSON список).  | `["*"]` (все источники)              |
| `CORS_CREDENTIALS`             | Разрешает ли CORS передачу credentials (например, cookie).               | `True`                                 |
| `CORS_METHODS`                 | Список разрешенных HTTP методов для CORS.                                | `["*"]` (все методы)                 |
| `CORS_HEADERS`                 | Список разрешенных HTTP заголовков для CORS.                             | `["*"]` (все заголовки)              |
| `POSTGRES_HOST`                | Хост базы данных PostgreSQL.                                               | `localhost`                            |
| `POSTGRES_PORT`                | Порт базы данных PostgreSQL.                                               | `5432`                                 |
| `POSTGRES_DB`                  | Имя базы данных в PostgreSQL.                                              | `game_service`                         |
| `POSTGRES_USER`                | Имя пользователя для подключения к PostgreSQL.                           | `bomberman`                            |
| `POSTGRES_PASSWORD`            | Пароль для подключения к PostgreSQL.                                     | `bomberman`                            |
| `REDIS_HOST`                   | Хост сервера Redis.                                                      | `localhost`                            |
| `REDIS_PORT`                   | Порт сервера Redis.                                                      | `6379`                                 |
| `REDIS_DB`                     | Номер базы данных Redis.                                                 | `0`                                    |
| `REDIS_PASSWORD`               | Пароль для подключения к Redis (если требуется).                         | `None`                                 |
| `NATS_URL`                     | URL для подключения к NATS серверу.                                      | `nats://localhost:4222`                |
| `LOG_LEVEL`                    | Уровень логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL).             | `INFO`                                 |
| `LOG_FORMAT`                   | Формат логов (`text` или `json`).                                        | `text`                                 |
| `TRACE_CALLER`                 | Включает ли добавление информации о вызывающих функциях в JSON логи.     | `True`                                 |
| `GAME_UPDATE_FPS`              | Целевая частота обновления игрового цикла (в кадрах в секунду).          | `30.0`                                 |
| `GAME_OVER_TIMEOUT`            | Таймаут перед фактическим удалением завершенной игры из памяти (в секундах). | `5.0`                                  |

**Вычисляемые переменные (в `app/config.py`):**

-   `DATABASE_URI`: Полный URI для подключения к PostgreSQL (синхронный, для Alembic).
-   `ASYNC_DATABASE_URI`: Полный URI для асинхронного подключения к PostgreSQL (`postgresql+asyncpg`).
-   `REDIS_URI`: Полный URI для подключения к Redis.

## 2. Настройки игровой сессии (`app/entities/game_settings.py`)

Эти настройки определяют параметры конкретной игровой сессии. Часть из них имеет значения по умолчанию, заданные в классе `GameSettings`, а часть может быть переопределена при создании игры через модель `GameCreateSettings`.

### 2.1. Системные/глобальные игровые параметры (обычно не изменяются при создании игры)

Эти параметры являются частью `GameSettings`, но обычно устанавливаются глобально для всех игр и не переопределяются через `GameCreateSettings`.

| Параметр                       | Описание                                                      | Значение по умолчанию (`GameSettings`) |
| :----------------------------- | :------------------------------------------------------------ | :------------------------------------- |
| `cell_size`                    | Размер ячейки на карте в пикселях.                            | `40`                                   |
| `default_map_width`            | Ширина карты по умолчанию (если не загружена из шаблона).     | `23`                                   |
| `default_map_height`           | Высота карты по умолчанию.                                    | `23`                                   |
| `player_default_speed`         | Скорость игрока по умолчанию.                                 | `3.0`                                  |
| `player_invulnerable_time`     | Время неуязвимости игрока после получения урона (секунды).    | `2.0`                                  |
| `bomb_timer`                   | Время до взрыва бомбы (секунды).                              | `2.0`                                  |
| `bomb_explosion_duration`      | Длительность отображения взрыва бомбы (секунды).              | `0.5`                                  |
| `default_bomb_power`           | Сила взрыва бомбы по умолчанию (радиус).                      | `1`                                    |
| `default_max_bombs`            | Максимальное количество одновременно установленных бомб.        | `1`                                    |
| `bullet_speed`                 | Скорость полета пули.                                         | `5.0`                                  |
| `mine_timer`                   | Время до взрыва мины после активации (для мин, которые не взрываются сразу). | `1.0` (в `Mine.update`, не `GameSettings.mine_timer` который `5.0`) |
| `enemy_count_multiplier`       | Множитель количества врагов в зависимости от уровня.          | `1.0`                                  |
| `enemy_destroy_animation_time` | Время анимации уничтожения врага (секунды).                   | `0.5`                                  |
| `enemy_invulnerable_time`      | Время неуязвимости врага после получения урона (секунды).     | `2.0`                                  |
| `block_destroy_score`          | Очки за уничтожение разрушаемого блока.                       | `10`                                   |
| `enemy_destroy_score`          | Очки за уничтожение врага.                                    | `100`                                  |
| `powerup_collect_score`        | Очки за подбор усиления.                                      | `25`                                   |
| `level_complete_score`         | Очки за завершение уровня (в режиме Кампания).               | `500`                                  |
| `powerup_drop_chance`          | Вероятность выпадения усиления из разрушаемого блока.         | `0.2`                                  |
| `enemy_powerup_drop_chance`    | Вероятность выпадения усиления из врага.                      | `0.3`                                  |
| `enable_snake_walls`           | Использовать генерацию стен "змейкой" для случайных карт.       | `False`                                |
| `allow_enemies_near_players`   | Разрешать ли спавн врагов близко к игрокам на случайных картах.| `False`                                |
| `min_distance_from_players`    | Минимальное расстояние (в клетках) от игроков для спавна врагов. | `1`                                    |

### 2.2. Параметры, настраиваемые при создании игры

Эти параметры передаются при создании новой игры (см. событие NATS `game.create` и модель `app/models/game_create_models.py:GameCreateSettings`). Они переопределяют соответствующие значения в `GameSettings` для конкретной сессии.

| Параметр (`GameCreateSettings`) | Соответствующее поле в `GameSettings` | Описание                                                                 | По умолчанию (`GameCreateSettings`) |
| :---------------------------- | :------------------------------------ | :----------------------------------------------------------------------- | :---------------------------------- |
| `game_id`                     | `game_id`                             | Уникальный идентификатор игры (может быть присвоен сервером).          | `None`                              |
| `game_mode`                   | `game_mode`                           | Режим игры (`campaign`, `free_for_all`, `capture_the_flag`).           | `GameModeType.CAMPAIGN`             |
| `max_players`                 | `max_players`                         | Максимальное количество игроков в сессии.                               | `4`                                 |
| `team_count`                  | `team_count`                          | Количество команд (актуально для CTF, FFA сам определяет).             | `1`                                 |
| `player_start_lives`          | `player_start_lives`                  | Начальное количество жизней у игроков.                                  | `3`                                 |
| `enable_enemies`              | `enable_enemies`                      | Включать ли врагов на карте.                                             | `True`                              |
| `map_chain_id`                | `map_chain_id`                        | ID цепочки карт для последовательного прохождения.                       | `None`                              |
| `map_template_id`             | `map_template_id`                     | ID шаблона карты для одиночной игры.                                   | `None`                              |
| `respawn_enabled`             | `respawn_enabled`                     | Включен ли респавн игроков после смерти (зависит от режима).           | `False`                             |
| `friendly_fire`               | `friendly_fire`                       | Включен ли урон по своим (огонь по своим).                               | `False`                             |
| `time_limit`                  | `time_limit`                          | Лимит времени на игру/раунд в секундах.                                | `300` (5 минут)                     |
| `score_limit`                 | `score_limit`                         | Лимит очков для победы в игре/раунде.                                  | `10`                                |
| `rounds_count`                | `rounds_count`                        | Количество раундов в игре.                                             | `15`                                |

При создании игры через `GameCoordinator` (`game_create`), если передается объект `GameCreateSettings`, его поля используются для инициализации `GameSettings` для этой игровой сессии. Если `GameCreateSettings` не передан, используются отдельные `kwargs` (`game_id`, `game_mode`, `map_template_id`, `map_chain_id`), а остальные параметры `GameSettings` берутся по умолчанию. 