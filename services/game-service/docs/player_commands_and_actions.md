# Команды Игрока и Их Обработка

В этом разделе подробно описывается, как игровой сервис (`game-service`) принимает, интерпретирует и обрабатывает команды, поступающие от игроков. Эти команды управляют движением персонажей, использованием оружия и другими ключевыми игровыми действиями.

## 1. Источники Команд Игрока

Основным способом для игрока передать свои намерения в игру являются NATS-сообщения. Два ключевых события обрабатывают большую часть действий:

-   **`game.input`**: Передает состояние кнопок движения и основных/вторичных действий (обычно использование оружия).
-   **`game.apply_weapon`**: Явная команда на использование определенного типа оружия. (Событие `game.place_bomb` является устаревшим синонимом для применения бомбы).

Эти события подробно описаны в разделе [NATS События](./nats_events.md).

## 2. Обработка Команд Движения и Базовых Действий (`game.input`)

Событие `game.input` несет в себе информацию о текущем состоянии нажатых клавиш игрока.

-   **Payload**: Содержит `game_id`, `player_id` и словарь `inputs` (типа `PlayerInputs` из `app/entities/player.py`):
    ```json
    {
      "up": false, "down": false, "left": true, "right": false, // Движение
      "weapon1": false, // Основное оружие/действие
      "weapon2": false  // Вторичное оружие/действие
    }
    ```
-   **Первичная обработка**:
    1.  `EventService` получает сообщение и передает его в `GameCoordinator`.
    2.  `GameCoordinator` находит соответствующий экземпляр `GameService` и внутри него объект `Player`.
    3.  Вызывается метод `player.set_inputs(inputs)`.
        -   Внутри `Player.set_inputs()`:
            -   Обновляется внутренний словарь `player.inputs`.
            -   Если `player.unit_type` равен `UnitType.TANK`, также обновляется `player.direction` на основе нажатых клавиш движения (вверх, вниз, влево, вправо). Это направление используется для определения, куда будет стрелять танк. Для `UnitType.BOMBERMAN` направление обычно определяется последним вектором движения, который рассчитывается в `GameModeService`.

-   **Логика в Игровом Цикле (`GameModeService`)**:
    Сохраненное состояние `player.inputs` используется в методе `update_player()` (или аналогичном) внутри активного `GameModeService` (например, `CampaignMode`, `FreeForAllMode`) во время каждого тика игрового цикла:
    -   **Движение**: На основе флагов `up`, `down`, `left`, `right` и `player.speed` рассчитывается новая позиция игрока. Применяется проверка столкновений с границами карты, стенами (`CellType.SOLID_WALL`), разрушаемыми блоками (`CellType.BREAKABLE_BLOCK`) и другими сущностями.
    -   **Использование оружия (из `weapon1`, `weapon2`)**:
        -   Если в `player.inputs` флаг `weapon1` или `weapon2` установлен в `True`, `GameModeService` инициирует логику применения соответствующего оружия (`player.primary_weapon` или `player.secondary_weapon`).
        -   Это обычно включает вызов метода `game_mode_service.apply_weapon(player_id, weapon_type)`, который проверяет, может ли игрок использовать это оружие (например, не превышено ли `player.max_weapons` для бомб, нет ли кулдауна).
        -   При успешной проверке создается объект оружия (например, `Bomb`, `Mine`) и размещается на карте, или, в случае `Bullet`, создается и начинает движение.

## 3. Обработка Явной Команды Применения Оружия (`game.apply_weapon`)

Это событие позволяет игроку явно указать, какой тип оружия он хочет использовать.

-   **Payload**: Содержит `game_id`, `player_id` и опциональное `weapon_type` (из `WeaponType`).
    ```json
    {
      "game_id": "id_игры",
      "player_id": "id_игрока",
      "weapon_type": "bomb" // "bomb", "bullet", "mine"
    }
    ```
-   **Обработка**:
    1.  `EventService` -> `GameCoordinator`.
    2.  `GameCoordinator` вызывает `game_service.apply_weapon(player_id, weapon_type)`.
    3.  `GameService` делегирует вызов `game_mode_service.apply_weapon(player_id, weapon_type)`.
    4.  В `GameModeService.apply_weapon()`:
        -   Определяется тип оружия, которое нужно применить. Если `weapon_type` не указан в payload, может использоваться `player.primary_weapon` по умолчанию.
        -   **Проверки**:
            -   Достаточно ли у игрока "зарядов" или не превышен ли лимит (например, `active_bombs_count < player.max_weapons` для бомб).
            -   Нет ли активного кулдауна на использование этого типа оружия.
        -   **Создание и активация**:
            -   Если проверки пройдены, создается экземпляр оружия (`Bomb`, `Bullet`, `Mine`).
            -   Для `Bomb` и `Mine`: объект размещается на карте в текущей или соседней клетке игрока. Его таймер (`weapon.timer`) начинает отсчет в его методе `update()`, но фактический взрыв бомбы (вызов `bomb.activate()`) инициируется `GameModeService` по истечении `GameSettings.bomb_timer`. Для мины, `mine.trigger()` вызывается при контакте, а затем ее собственный `update()` может привести к `activate()`.
            -   Для `Bullet`: объект создается с направлением `player.direction` и скоростью `player.speed` (или `GameSettings.bullet_speed`). Пуля начинает движение немедленно.

## 4. Влияние Типа Юнита Игрока и Игровых Режимов

### 4.1. Тип Юнита (`Player.unit_type`)

Тип юнита, выбранный игроком (`BOMBERMAN` или `TANK`), существенно влияет на доступные команды и их интерпретацию:

-   **`UnitType.BOMBERMAN`**:
    -   `primary_weapon`: `WeaponType.BOMB`.
    -   `secondary_weapon`: `WeaponType.MINE`.
    -   `player.max_weapons`: Определяет, сколько бомб игрок может одновременно разместить. Увеличивается усилением `PowerUpType.BOMB_UP`.
    -   `player.weapon_power`: Определяет радиус взрыва бомб. Увеличивается усилением `PowerUpType.BOMB_POWER_UP`.
    -   Движение стандартное в 4 направлениях.

-   **`UnitType.TANK`**:
    -   `primary_weapon`: `WeaponType.BULLET`.
    -   `secondary_weapon`: `WeaponType.MINE`.
    -   `player.max_weapons`: Обычно больше (например, 10), что позволяет выпускать несколько пуль подряд (логика кулдауна между выстрелами обрабатывается в `GameModeService`).
    -   `player.weapon_power`: Может влиять на урон от пуль (если такая механика будет добавлена) или другие их характеристики.
    -   `player.direction`: Обновляется на основе команд движения и используется для определения направления выстрела пули. Танк стреляет в направлении, в котором "смотрит".

### 4.2. Игровые Режимы (`GameModeService` и его реализации)

Хотя базовая логика обработки команд движения и применения оружия в основном одинакова и реализована в `GameModeService`, специфические правила режима могут влиять на результат:

-   **`CampaignMode`**:
    -   Команды работают стандартно. Цели уровня (уничтожение врагов, достижение выхода) не влияют на сами команды, а на условия победы/поражения.
-   **`FreeForAllMode`**:
    -   Команды работают стандартно. `friendly_fire` из `GameSettings` определяет, будут ли свои же бомбы наносить урон.
-   **`CaptureTheFlagMode`**:
    -   Движение и использование оружия стандартные.
    -   Взаимодействие с флагами (подбор, установка на базу) обычно реализуется через логику столкновений при движении, а не через отдельные "команды". То есть, команда "двигаться на клетку с флагом" приводит к его подбору, если это возможно по правилам режима.

## 5. Команды "По Умолчанию" и Неявные Действия

-   **Отсутствие ввода**: Если игрок не нажимает кнопок движения, его персонаж стоит на месте.
-   **Направление взгляда/атаки**:
    -   Для `BOMBERMAN`: Бомбы и мины ставятся на текущую или соседнюю клетку. Направление не так критично для самого акта установки.
    -   Для `TANK`: Направление стрельбы определяется `player.direction`, которое меняется при движении. Если танк стоит на месте и нажимает "огонь", он стреляет в последнем запомненном направлении.
-   **Автоматические действия**: Некоторые действия могут происходить автоматически как реакция на другие события, а не прямые команды:
    -   Взрыв бомбы по таймеру.
    -   Активация мины при контакте.
    -   Подбор усилений при наступании на них.

## 6. Роль `GameSettings`

Многие параметры из `GameSettings` (глобальные и для сессии) влияют на выполнение команд:
-   `player_default_speed`, `bullet_speed`: влияют на движение.
-   `bomb_timer`, `default_bomb_power`, `default_max_bombs`: влияют на характеристики и использование бомб.
-   `friendly_fire`: определяет, может ли игрок навредить себе или союзникам своим оружием.

## Заключение

Система команд в `game-service` построена на основе NATS-событий, которые обновляют состояние игрока. Затем, в основном игровом цикле, `GameModeService` использует это состояние для выполнения действий, таких как движение и применение оружия, с учетом типа юнита игрока, правил текущего игрового режима и глобальных настроек игры. Сложность и нюансы поведения возникают из взаимодействия этих компонентов. 