# HTTP API Endpoints

Game Service предоставляет RESTful API для управления ресурсами, связанными с картами, командами и играми. Все эндпоинты, описанные ниже, требуют аутентификации пользователя.

Префикс для всех эндпоинтов карт: `{settings.API_V1_STR}/maps` (например, `/games/api/v1/maps`).
Префикс для всех эндпоинтов команд: `{settings.API_V1_STR}/teams` (например, `/games/api/v1/teams`).
Префикс для всех эндпоинтов игр: `{settings.API_V1_STR}/games` (например, `/games/api/v1/games`).

## Общие эндпоинты (из `app/main.py`)

-   **`GET /health`**
    -   Описание: Проверка состояния сервиса.
    -   Ответ: JSON с полем `status` (`ok` или `error`).
    -   Пример ответа: `{"status": "ok", "service": "game-service"}`

-   **`GET /metrics`**
    -   Описание: Предоставляет метрики в формате Prometheus.
    -   Ответ: Текстовый ответ с метриками.

-   **`GET {settings.SWAGGER_URL}`** (например, `/games/docs`)
    -   Описание: Пользовательский интерфейс Swagger для интерактивной документации API.

-   **`GET {settings.SWAGGER_URL}/openapi.json`** (например, `/games/docs/openapi.json`)
    -   Описание: Спецификация OpenAPI в формате JSON.

## Эндпоинты для Игр (`/games`)

Эти эндпоинты управляют игровыми сессиями, позволяя создавать, настраивать и контролировать игры.

### `GET /games/`

-   Описание: Получить список игр с фильтрацией.
-   Параметры запроса (Query Parameters):
    -   `status: Optional[GameStatus]`: Фильтр по статусу игры (`pending`, `starting`, `active`, `paused`, `finished`).
    -   `game_mode: Optional[GameModeType]`: Фильтр по режиму игры (`campaign`, `free_for_all`, `capture_the_flag`).
    -   `has_free_slots: Optional[bool]`: Только игры со свободными местами для игроков.
    -   `min_players: Optional[int]`: Минимальное количество игроков (0-8).
    -   `max_players: Optional[int]`: Максимальное количество игроков (1-8).
    -   `limit: int`: Количество записей на страницу (по умолчанию 20, макс. 100).
    -   `offset: int`: Смещение для пагинации (по умолчанию 0).
-   Ответ: `List[GameListItem]` (см. [Модели данных для игр](#модели-данных-для-игр)).
-   Аутентификация: Требуется.

### `GET /games/{game_id}`

-   Описание: Получить подробную информацию об игре.
-   Параметр пути:
    -   `game_id: str`: Уникальный идентификатор игры.
-   Ответ: `GameInfo` (см. [Модели данных для игр](#модели-данных-для-игр)).
-   Статус код при ошибке: `404 Not Found` (игра не найдена).
-   Аутентификация: Требуется.

### `POST /games/`

-   Описание: Создать новую игру.
-   Тело запроса: `GameCreateSettings` (см. [Модели данных для создания игры](./architecture/models.md#24-модели-для-создания-игры)).
-   Ответ: `GameCreateResponse` (см. [Модели данных для игр](#модели-данных-для-игр)).
-   Статус код при успехе: `201 Created`.
-   Аутентификация: Требуется.

### `PUT /games/{game_id}/settings`

-   Описание: Обновить настройки игры (только в статусе `PENDING`).
-   Параметр пути:
    -   `game_id: str`: Уникальный идентификатор игры.
-   Тело запроса: `GameSettingsUpdate` (см. [Модели данных для игр](#модели-данных-для-игр)).
-   Ответ: `StandardResponse` (см. [Модели данных для игр](#модели-данных-для-игр)).
-   Статус код при ошибке:
    -   `404 Not Found` (игра не найдена)
    -   `400 Bad Request` (игра не в статусе PENDING)
-   Аутентификация: Требуется.

### `PUT /games/{game_id}/status`

-   Описание: Изменить статус игры (start/pause/resume).
-   Параметр пути:
    -   `game_id: str`: Уникальный идентификатор игры.
-   Тело запроса: `GameStatusUpdate` (см. [Модели данных для игр](#модели-данных-для-игр)).
    ```json
    {
      "action": "start" // "start", "pause", "resume"
    }
    ```
-   Ответ: `StandardResponse` (см. [Модели данных для игр](#модели-данных-для-игр)).
-   Статус код при ошибке:
    -   `404 Not Found` (игра не найдена)
    -   `400 Bad Request` (некорректное действие для текущего статуса)
-   Аутентификация: Требуется.

### `POST /games/{game_id}/players`

-   Описание: Добавить игрока в игру.
-   Параметр пути:
    -   `game_id: str`: Уникальный идентификатор игры.
-   Тело запроса: `PlayerAction` (см. [Модели данных для игр](#модели-данных-для-игр)).
    ```json
    {
      "player_id": "player_123",
      "unit_type": "bomberman" // "bomberman" или "tank"
    }
    ```
-   Ответ: `StandardResponse` с дополнительными данными об игроке.
-   Статус код при ошибке:
    -   `404 Not Found` (игра не найдена)
    -   `400 Bad Request` (игра заполнена или другие ограничения)
-   Аутентификация: Требуется.

### `DELETE /games/{game_id}/players/{player_id}`

-   Описание: Удалить игрока из игры.
-   Параметры пути:
    -   `game_id: str`: Уникальный идентификатор игры.
    -   `player_id: str`: Уникальный идентификатор игрока.
-   Ответ: `StandardResponse`.
-   Статус код при ошибке:
    -   `404 Not Found` (игра или игрок не найдены)
    -   `400 Bad Request` (игрок не в игре)
-   Аутентификация: Требуется.

### `DELETE /games/{game_id}`

-   Описание: Удалить игру (только в статусе `PENDING` или `FINISHED`).
-   Параметр пути:
    -   `game_id: str`: Уникальный идентификатор игры.
-   Ответ: `StandardResponse`.
-   Статус код при успехе: `204 No Content`.
-   Статус код при ошибке:
    -   `404 Not Found` (игра не найдена)
    -   `400 Bad Request` (игра в неподходящем статусе)
-   Аутентификация: Требуется.

## Модели данных для игр

### `GameListItem`
```json
{
  "game_id": "uuid",
  "status": "pending",
  "game_mode": "campaign",
  "current_players_count": 2,
  "max_players": 4,
  "level": 1,
  "created_at": "2024-01-01T00:00:00Z"
}
```

### `GameInfo`
```json
{
  "game_id": "uuid",
  "status": "active",
  "game_mode": "campaign",
  "max_players": 4,
  "current_players_count": 2,
  "team_count": 1,
  "level": 1,
  "score": 150,
  "game_over": false,
  "players": [
    {
      "id": "player_1",
      "name": "Player 1",
      "unit_type": "bomberman",
      "team_id": "team_1",
      "lives": 3,
      "x": 40.0,
      "y": 40.0,
      "color": "#3498db",
      "invulnerable": false
    }
  ],
  "teams": [
    {
      "id": "team_1",
      "name": "Team Alpha",
      "score": 150,
      "player_ids": ["player_1", "player_2"],
      "player_count": 2
    }
  ],
  "settings": {
    "game_mode": "campaign",
    "max_players": 4,
    "player_start_lives": 3,
    "enable_enemies": true
    // ... другие настройки
  },
  "created_at": "2024-01-01T00:00:00Z",
  "updated_at": "2024-01-01T00:05:00Z"
}
```

### `GameSettingsUpdate`
```json
{
  "max_players": 6,
  "team_count": 2,
  "player_start_lives": 5,
  "enable_enemies": false,
  "respawn_enabled": true,
  "friendly_fire": false,
  "time_limit": 600,
  "score_limit": 20,
  "rounds_count": 10
}
```

### `GameCreateResponse`
```json
{
  "success": true,
  "game_id": "uuid",
  "message": "Game created successfully"
}
```

### `StandardResponse`
```json
{
  "success": true,
  "message": "Operation completed successfully",
  "data": null
}
```

## Эндпоинты для Команд (`/teams`)

Эти эндпоинты управляют командами в игровых сессиях. Все операции с командами доступны только для игр со статусом `PENDING`.

### `GET /teams/{game_id}`

-   Описание: Получить список команд для конкретной игры.
-   Параметр пути:
    -   `game_id: str`: Уникальный идентификатор игры.
-   Ответ: `List[Team]` (см. [Модели данных](./architecture/models.md#221-команды-team)).
-   Статус код при ошибке (не найдено): `404 Not Found`.
-   Аутентификация: Требуется.

### `POST /teams/{game_id}`

-   Описание: Создать новую команду в игре.
-   Параметр пути:
    -   `game_id: str`: Уникальный идентификатор игры.
-   Тело запроса: `TeamCreate` (см. [Модели данных](./architecture/models.md#221-команды-team)).
-   Ответ: `Team` (созданная команда).
-   Статус код при успехе: `201 Created`.
-   Статус код при ошибке: 
    -   `404 Not Found` (игра не найдена)
    -   `400 Bad Request` (игра не в статусе PENDING или превышен лимит команд)
-   Аутентификация: Требуется.

### `PUT /teams/{game_id}/{team_id}`

-   Описание: Обновить существующую команду.
-   Параметры пути:
    -   `game_id: str`: Уникальный идентификатор игры.
    -   `team_id: str`: Уникальный идентификатор команды.
-   Тело запроса: `TeamUpdate` (см. [Модели данных](./architecture/models.md#221-команды-team)).
-   Ответ: `Team` (обновленная команда).
-   Статус код при ошибке:
    -   `404 Not Found` (игра или команда не найдены)
    -   `400 Bad Request` (игра не в статусе PENDING)
-   Аутентификация: Требуется.

### `DELETE /teams/{game_id}/{team_id}`

-   Описание: Удалить команду из игры.
-   Параметры пути:
    -   `game_id: str`: Уникальный идентификатор игры.
    -   `team_id: str`: Уникальный идентификатор команды.
-   Ответ: Пустой ответ.
-   Статус код при успехе: `204 No Content`.
-   Статус код при ошибке:
    -   `404 Not Found` (игра или команда не найдены)
    -   `400 Bad Request` (игра не в статусе PENDING)
-   Аутентификация: Требуется.

### `POST /teams/{game_id}/{team_id}/players`

-   Описание: Добавить игрока в команду.
-   Параметры пути:
    -   `game_id: str`: Уникальный идентификатор игры.
    -   `team_id: str`: Уникальный идентификатор команды.
-   Тело запроса: `PlayerTeamAction` (см. [Модели данных](./architecture/models.md#222-действия-с-игроками-в-командах)).
-   Ответ: `Team` (обновленная команда).
-   Статус код при ошибке:
    -   `404 Not Found` (игра, команда или игрок не найдены)
    -   `400 Bad Request` (игра не в статусе PENDING или превышен лимит игроков в команде)
-   Аутентификация: Требуется.

### `DELETE /teams/{game_id}/{team_id}/players/{player_id}`

-   Описание: Удалить игрока из команды.
-   Параметры пути:
    -   `game_id: str`: Уникальный идентификатор игры.
    -   `team_id: str`: Уникальный идентификатор команды.
    -   `player_id: str`: Уникальный идентификатор игрока.
-   Ответ: `Team` (обновленная команда).
-   Статус код при ошибке:
    -   `404 Not Found` (игра, команда или игрок не найдены)
    -   `400 Bad Request` (игра не в статусе PENDING)
-   Аутентификация: Требуется.

### `POST /teams/{game_id}/distribute`

-   Описание: Автоматически распределить игроков по командам согласно настройкам игрового режима.
-   Параметр пути:
    -   `game_id: str`: Уникальный идентификатор игры.
-   Тело запроса: `TeamDistributionRequest` (см. [Модели данных](./architecture/models.md#222-действия-с-игроками-в-командах)).
-   Ответ: `List[Team]` (обновленный список команд с распределенными игроками).
-   Статус код при ошибке:
    -   `404 Not Found` (игра не найдена)
    -   `400 Bad Request` (игра не в статусе PENDING)
-   Аутентификация: Требуется.

### `GET /teams/{game_id}/validate`

-   Описание: Проверить корректность настройки команд в игре.
-   Параметр пути:
    -   `game_id: str`: Уникальный идентификатор игры.
-   Ответ: 
    ```json
    {
        "is_valid": boolean,
        "errors": ["список ошибок валидации"]
    }
    ```
-   Статус код при ошибке: `404 Not Found` (игра не найдена).
-   Аутентификация: Требуется.

## Эндпоинты для Шаблонов Карт (`/templates`)

Эти эндпоинты управляют шаблонами карт, которые служат основой для создания игровых полей.

### `POST /templates`

-   Описание: Создать новый шаблон карты.
-   Тело запроса: `MapTemplateCreate` (см. [Модели данных](./architecture/models.md#maptemplatecreate)).
-   Ответ: `MapTemplate` (см. [Модели данных](./architecture/models.md#maptemplate)).
-   Статус код при успехе: `201 Created`.
-   Аутентификация: Требуется.

### `GET /templates`

-   Описание: Получить список шаблонов карт с возможностью фильтрации и пагинации.
-   Параметры запроса (Query Parameters):
    -   `name: Optional[str]`: Фильтр по части имени карты (регистронезависимый).
    -   `difficulty_min: Optional[int]`: Минимальная сложность (1-10).
    -   `difficulty_max: Optional[int]`: Максимальная сложность (1-10).
    -   `max_players_min: Optional[int]`: Минимальное количество игроков (1-8).
    -   `max_players_max: Optional[int]`: Максимальное количество игроков (1-8).
    -   `created_by: Optional[str]`: ID пользователя, создавшего шаблон.
    -   `limit: int`: Количество записей на страницу (по умолчанию 20, макс. 100).
    -   `offset: int`: Смещение для пагинации (по умолчанию 0).
-   Ответ: `List[MapTemplate]`.
-   Аутентификация: Требуется.

### `GET /templates/{template_id}`

-   Описание: Получить конкретный шаблон карты по его ID.
-   Параметр пути (Path Parameter):
    -   `template_id: str`: Уникальный идентификатор шаблона карты.
-   Ответ: `MapTemplate`.
-   Статус код при ошибке (не найдено): `404 Not Found`.
-   Аутентификация: Требуется.

### `PUT /templates/{template_id}`

-   Описание: Обновить существующий шаблон карты.
-   Параметр пути:
    -   `template_id: str`: ID обновляемого шаблона.
-   Тело запроса: `MapTemplateUpdate` (см. [Модели данных](./architecture/models.md#maptemplateupdate)) - передаются только изменяемые поля.
-   Ответ: `MapTemplate` (обновленный).
-   Аутентификация: Требуется. Редактировать может только создатель шаблона или администратор.
-   Статус код при ошибке: `404 Not Found` (шаблон не найден), `403 Forbidden` (нет прав).

### `DELETE /templates/{template_id}`

-   Описание: Удалить шаблон карты (мягкое удаление - устанавливается флаг `is_active=False`).
-   Параметр пути:
    -   `template_id: str`: ID удаляемого шаблона.
-   Ответ: Пустой ответ.
-   Статус код при успехе: `204 No Content`.
-   Аутентификация: Требуется. Удалить может только создатель шаблона или администратор.
-   Статус код при ошибке: `404 Not Found` (шаблон не найден), `403 Forbidden` (нет прав).

## Эндпоинты для Групп Карт (`/groups`)

Группы карт позволяют объединять несколько шаблонов карт вместе (например, для случайного выбора карты из набора).

### `POST /groups`

-   Описание: Создать новую группу карт.
-   Тело запроса: `MapGroupCreate` (см. [Модели данных](./architecture/models.md#mapgroupcreate)).
-   Ответ: `MapGroup` (см. [Модели данных](./architecture/models.md#mapgroup)).
-   Статус код при успехе: `201 Created`.
-   Аутентификация: Требуется.

### `GET /groups`

-   Описание: Получить список групп карт с фильтрацией и пагинацией.
-   Параметры запроса (Query Parameters):
    -   `name: Optional[str]`: Фильтр по части имени группы.
    -   `created_by: Optional[str]`: ID пользователя, создавшего группу.
    -   `limit: int`: Количество записей (по умолчанию 20, макс. 100).
    -   `offset: int`: Смещение (по умолчанию 0).
-   Ответ: `List[MapGroup]`.
-   Аутентификация: Требуется.

### `GET /groups/{group_id}`

-   Описание: Получить конкретную группу карт по ID.
-   Параметр пути:
    -   `group_id: str`: ID группы карт.
-   Ответ: `MapGroup`.
-   Статус код при ошибке (не найдено): `404 Not Found`.
-   Аутентификация: Требуется.

*(Примечание: Эндпоинты для обновления и удаления групп карт (PUT, DELETE) на данный момент не реализованы в `app/routes/map_routes.py`, хотя соответствующие Pydantic модели для обновления существуют.)*

## Эндпоинты для Цепочек Карт (`/chains`)

Цепочки карт предназначены для последовательного прохождения набора карт (например, в режиме кампании).

### `POST /chains`

-   Описание: Создать новую цепочку карт.
-   Тело запроса: `MapChainCreate` (см. [Модели данных](./architecture/models.md#mapchaincreate)).
-   Ответ: `MapChain` (см. [Модели данных](./architecture/models.md#mapchain)).
-   Статус код при успехе: `201 Created`.
-   Аутентификация: Требуется.

### `GET /chains`

-   Описание: Получить список цепочек карт с фильтрацией и пагинацией.
-   Параметры запроса (Query Parameters):
    -   `name: Optional[str]`: Фильтр по части имени цепочки.
    -   `created_by: Optional[str]`: ID пользователя, создавшего цепочку.
    -   `limit: int`: Количество записей (по умолчанию 20, макс. 100).
    -   `offset: int`: Смещение (по умолчанию 0).
-   Ответ: `List[MapChain]`.
-   Аутентификация: Требуется.

### `GET /chains/{chain_id}`

-   Описание: Получить конкретную цепочку карт по ID.
-   Параметр пути:
    -   `chain_id: str`: ID цепочки карт.
-   Ответ: `MapChain`.
-   Статус код при ошибке (не найдено): `404 Not Found`.
-   Аутентификация: Требуется.

*(Примечание: Эндпоинты для обновления и удаления цепочек карт (PUT, DELETE) на данный момент не реализованы в `app/routes/map_routes.py`, хотя соответствующие Pydantic модели для обновления существуют.)*

## Аутентификация и Авторизация

Все эндпоинты требуют аутентификации. Сервис ожидает, что информация о пользователе (`id`, `role`, `email`, `username`) будет передана в заголовках запроса (например, `X-User-ID`, `X-User-Role`), установленных вышестоящим шлюзом (например, Traefik) после проверки JWT токена.

-   Для операций создания (`POST`) и чтения (`GET`) обычно достаточно быть аутентифицированным пользователем.
-   Для операций изменения (`PUT`) и удаления (`DELETE`) шаблонов карт требуется, чтобы текущий пользователь был либо создателем ресурса, либо имел роль `admin`.
-   Операции с командами и играми доступны всем аутентифицированным пользователям, но с ограничениями по статусу игры. 