# Логика Работы Команд (Teams)

В этом документе описывается, как в `game-service` реализована логика команд (teams), включая их создание, назначение игроков, управление через REST API и специфику поведения в различных игровых режимах.

## 1. Общее Представление о Командах

### 1.1. Архитектура Системы Команд

Система команд в `game-service` построена с использованием выделенного сервиса `TeamService`, который инкапсулирует всю логику управления командами в рамках игровой сессии:

-   **Команды как объекты**: Каждая команда представлена классом `Team` с уникальным идентификатором, названием, счетом и списком игроков.
-   **Идентификация игроков**: Каждый игрок (`Player`) имеет атрибут `team_id` (строка), который определяет его принадлежность к команде.
-   **Централизованное управление**: `TeamService` управляет всеми операциями с командами: создание, обновление, удаление, добавление/удаление игроков.
-   **Командная система очков**: Очки начисляются командам, а не отдельным игрокам, за различные игровые достижения.

### 1.2. Основные Компоненты

-   **`Team`** (`app/entities/team.py`): Класс представляющий команду с методами управления игроками и счетом.
-   **`TeamService`** (`app/services/team_service.py`): Сервис для управления командами в игровой сессии.
-   **`TeamModeSettings`** (`app/entities/team_settings.py`): Настройки команд для каждого игрового режима.
-   **API модели** (`app/models/team_models.py`): Pydantic модели для REST API управления командами.
-   **REST API** (`app/routes/team_routes.py`): HTTP эндпоинты для управления командами.

## 2. Настройки Команд по Игровым Режимам

Каждый игровой режим имеет предустановленные настройки команд, определенные в `TEAM_MODE_SETTINGS`:

### 2.1. Режим "Кампания" (CAMPAIGN)

```python
TeamModeSettings(
    default_team_count=1,          # Одна команда
    max_team_count=1,              # Максимум одна команда
    min_players_per_team=1,        # Минимум 1 игрок
    max_players_per_team=8,        # Максимум 8 игроков
    auto_distribute_players=True,   # Автоматическое распределение
    allow_uneven_teams=True,       # Неравные команды разрешены
    default_team_names=["Heroes"]  # Название по умолчанию
)
```

### 2.2. Режим "Каждый за Себя" (FREE_FOR_ALL)

```python
TeamModeSettings(
    default_team_count=0,          # Динамическое количество команд
    max_team_count=8,              # Максимум 8 команд (по числу игроков)
    min_players_per_team=1,        # Ровно 1 игрок в команде
    max_players_per_team=1,        # Ровно 1 игрок в команде
    auto_distribute_players=True,   # Автоматическое распределение
    allow_uneven_teams=True,       # Неравные команды разрешены
    default_team_names=[]          # Имена генерируются автоматически
)
```

### 2.3. Режим "Захват Флага" (CAPTURE_THE_FLAG)

```python
TeamModeSettings(
    default_team_count=2,          # Две команды
    max_team_count=4,              # Максимум 4 команды
    min_players_per_team=1,        # Минимум 1 игрок
    max_players_per_team=4,        # Максимум 4 игрока
    auto_distribute_players=True,   # Автоматическое распределение
    allow_uneven_teams=False,      # Команды должны быть равными
    default_team_names=["Red Team", "Blue Team", "Green Team", "Yellow Team"]
)
```

## 3. Жизненный Цикл Команд

### 3.1. Инициализация Команд

При создании игры происходит:

1. **Создание TeamService**: `GameService` создает экземпляр `TeamService` для текущего игрового режима.
2. **Настройка команд по умолчанию**: Вызывается `team_service.setup_default_teams()`, который создает команды согласно настройкам режима.
3. **Передача в игровой режим**: `TeamService` передается в конструктор `GameModeService`.

### 3.2. Добавление Игроков

При добавлении игрока в игру:

1. **Добавление в игровой режим**: Игрок добавляется через `game_mode.add_player()`.
2. **Автоматическое распределение**: Вызывается `team_service.auto_distribute_players()` для назначения игрока в команду.
3. **Обновление team_id**: У игрока устанавливается соответствующий `team_id`.

### 3.3. Алгоритмы Распределения

#### Режим "Кампания"
Все игроки добавляются в единственную команду "Heroes".

#### Режим "Каждый за Себя"
Для каждого игрока создается индивидуальная команда с названием "{PlayerName}'s Team".

#### Режим "Захват Флага"
Игроки равномерно распределяются по командам с использованием round-robin алгоритма для обеспечения баланса.

## 4. Командная Система Очков

### 4.1. Источники Очков

Команды получают очки за следующие действия:

-   **Уничтожение блоков**: `settings.block_destroy_score` очков за разрушение блока бомбой.
-   **Убийство врагов**: `settings.enemy_destroy_score` очков за уничтожение врага.
-   **Сбор усилений**: `settings.powerup_collect_score` очков за подбор усиления.
-   **Завершение уровня**: `settings.level_complete_score` очков за прохождение уровня (режим кампании).
-   **Победа в раунде**: Очки победителя в режиме "Каждый за Себя".

### 4.2. Начисление Очков

Очки начисляются через метод `team_service.add_score_to_player_team(player_id, points)`, который:

1. Находит команду игрока.
2. Добавляет указанное количество очков к счету команды.
3. Обновляет состояние команды.

## 5. REST API для Управления Командами

### 5.1. Доступные Операции

Система предоставляет полный REST API для управления командами:

-   **`GET /teams/{game_id}`**: Получение списка команд игры.
-   **`POST /teams/{game_id}`**: Создание новой команды.
-   **`PUT /teams/{game_id}/{team_id}`**: Обновление команды.
-   **`DELETE /teams/{game_id}/{team_id}`**: Удаление команды.
-   **`POST /teams/{game_id}/{team_id}/players`**: Добавление игрока в команду.
-   **`DELETE /teams/{game_id}/{team_id}/players/{player_id}`**: Удаление игрока из команды.
-   **`POST /teams/{game_id}/distribute`**: Автоматическое распределение игроков.
-   **`GET /teams/{game_id}/validate`**: Валидация настройки команд.

### 5.2. Ограничения

-   Все операции с командами доступны только для игр в статусе `PENDING`.
-   Соблюдаются лимиты количества команд и игроков в команде согласно настройкам режима.
-   Проверяется существование игрока в игре перед добавлением в команду.

## 6. Интеграция с Игровыми Режимами

### 6.1. Обновленная Архитектура

Игровые режимы больше не управляют командами напрямую. Вместо этого:

1. **Конструктор получает TeamService**: `GameModeService` принимает `TeamService` в конструкторе.
2. **Делегирование операций**: Методы `setup_teams()` в режимах теперь просто логируют завершение настройки.
3. **Использование командных очков**: Все операции начисления очков используют `TeamService`.

### 6.2. Специфика Режимов

#### CampaignMode
-   Использует единственную команду для всех игроков.
-   При завершении уровня очки начисляются команде через первого игрока.
-   Командная работа и кооперация.

#### FreeForAllMode
-   Каждый игрок имеет индивидуальную команду.
-   Победитель получает бонусные очки.
-   Соревновательный характер игры.

#### CaptureFlagMode
-   Использует балансированные команды.
-   Очки начисляются за командные достижения.
-   Стратегическая командная игра.

## 7. Валидация и Проверки

### 7.1. Автоматическая Валидация

`TeamService` предоставляет метод `validate_teams()`, который проверяет:

-   Соответствие минимальному количеству игроков в команде.
-   Равенство команд по размеру (если требуется настройками режима).
-   Соблюдение ограничений игрового режима.

### 7.2. Проверки при Запуске

При запуске игры (`game_service.start_game()`) выполняется валидация команд. Ошибки валидации логируются, но не блокируют запуск (только предупреждают).

## 8. Состояние Игры и Команды

### 8.1. Включение в Состояние

Информация о командах включается в состояние игры через `game_service.get_state()`:

```json
{
  "teams": {
    "team_id_1": {
      "id": "team_id_1",
      "name": "Red Team",
      "score": 150,
      "player_ids": ["player_1", "player_2"],
      "player_count": 2
    }
  }
}
```

### 8.2. Обновления Состояния

Состояние команд обновляется автоматически при:
-   Добавлении/удалении игроков из команды.
-   Начислении очков команде.
-   Изменении названия команды.

## 9. Миграция и Совместимость

### 9.1. Обратная Совместимость


### 9.2. Переход от Старой Системы

Старая система с словарем команд в `GameModeService` полностью заменена на `TeamService`, обеспечивая:
-   Более четкое разделение ответственности.
-   Централизованное управление командами.
-   Расширенные возможности через REST API.
-   Гибкие настройки для разных игровых режимов.

Эта система обеспечивает полноценную, гибкую и расширяемую функциональность для управления командами во всех поддерживаемых игровых режимах. 