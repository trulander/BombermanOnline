# Логика Работы Команд (Teams)

В этом документе описывается, как в `game-service` реализована логика команд (teams), включая их создание, назначение игроков и специфику поведения в различных игровых режимах.

## 1. Общее Представление о Командах

-   **Идентификация**: Каждый игрок (`Player`) имеет атрибут `team_id` (строка), который определяет его принадлежность к команде.
-   **Хранение**: В каждом игровом режиме (`GameModeService` и его наследниках) есть словарь `teams`, где ключ - это `team_id`, а значение - список `player_id` игроков в этой команде.
-   **Настройки**:
    -   `GameSettings.team_count`: Определяет желаемое количество команд в игре. Это значение используется при инициализации некоторых игровых режимов.
    -   `GameCreateSettings.team_count`: Параметр, передаваемый при создании игры через NATS, который затем отображается в `GameSettings.team_count`.

## 2. Инициализация Команд и Назначение Игроков

Логика создания команд и распределения по ним игроков в основном сосредоточена в методах `setup_teams()` и `add_player()` каждого конкретного игрового режима.

### 2.1. Базовый Класс `GameModeService`

-   `self.teams: Dict[str, List[str]] = {}`: Инициализируется пустым словарем.
-   `add_player(self, player: Player) -> bool`: Базовый метод добавляет игрока в общий список `self.players`, но не назначает команду. Назначение команды — ответственность конкретных режимов.
-   `remove_player(self, player_id: str) -> bool`: При удалении игрока он также удаляется из списка своей команды, если он там был.

### 2.2. Режим "Кампания" (`CampaignMode`)

-   **`setup_teams(self) -> None`**:
    -   Создается одна команда с фиксированным `team_id = "team_1"`.
    -   `self.teams = {"team_1": []}`.
-   **`add_player(self, player) -> bool`**:
    -   Если игрок успешно добавлен в игру (через вызов `super().add_player(player)`), он автоматически назначается в команду `"team_1"`.
    -   `player.set_team("team_1")`
    -   `self.teams["team_1"].append(player.id)`
-   **Логика**: В режиме кампании все игроки находятся в одной кооперативной команде.

### 2.3. Режим "Каждый за Себя" (`FreeForAllMode`)

-   **`setup_teams(self) -> None`**:
    -   Словарь `self.teams` инициализируется пустым. Команды создаются по мере добавления игроков.
-   **`add_player(self, player) -> bool`**:
    -   Для каждого добавленного игрока создается его собственная, уникальная команда.
    -   `team_id = f"team_{player.id}"`
    -   `player.set_team(team_id)`
    -   `self.teams[team_id] = [player.id]`
-   **Логика**: Каждый игрок выступает сам за себя, находясь в индивидуальной команде. `GameSettings.team_count` в этом режиме не используется напрямую для формирования команд, так как количество команд равно количеству игроков.

### 2.4. Режим "Захват Флага" (`CaptureTheFlagMode`)

-   **`setup_teams(self) -> None`**:
    -   Изначально `self.teams` пуст. Фактическая настройка команд откладывается до момента инициализации карты (`initialize_map`), так как количество команд и их привязка к флагам может зависеть от конфигурации карты.
    -   В текущей реализации, если карта не предоставляет специфичную информацию о флагах/командах, используется `self.settings.team_count` (по умолчанию 2 команды: `"team_1"`, `"team_2"`).
    -   `self.teams[team_id] = []`
    -   `self.captured_flags[team_id] = 0` (для отслеживания захваченных флагов каждой командой).
-   **`_setup_flags_and_teams(self) -> None`**:
    -   Этот метод вызывается после загрузки карты.
    -   В текущей реализации он создает количество команд, равное `max(2, self.settings.team_count)`.
    -   Предполагается, что в будущем здесь будет логика считывания позиций флагов с карты (`CellType.FLAG_SPAWN_TEAM_1`, `CellType.FLAG_SPAWN_TEAM_2` и т.д.) и создания команд на их основе.
-   **`add_player(self, player) -> bool`**:
    -   Игрок автоматически распределяется в команду с наименьшим количеством участников.
    -   Вызывается `_assign_player_to_team()`, который находит команду с минимальным количеством игроков и назначает туда нового игрока.
    -   `player.set_team(team_id)`
    -   `self.teams[team_id].append(player.id)`
-   **`assign_player_to_team(self, player_id: str, team_id: str) -> bool`**:
    -   Позволяет вручную переместить игрока в указанную команду.
    -   Удаляет игрока из старой команды и добавляет в новую. Этот метод доступен через `GameService.assign_player_to_team`.
-   **Логика**: Игроки делятся на предопределенное количество команд (обычно две), борющихся за захват флагов.

## 3. Управление Командами через `GameService`

-   **`_create_game_mode(self) -> GameModeService`**: В зависимости от `self.settings.game_mode` создает экземпляр соответствующего игрового режима, который уже содержит свою логику `setup_teams`.
-   **`add_player(self, player_id: str, unit_type: UnitType = UnitType.BOMBERMAN) -> bool`**: Создает объект `Player` и делегирует его добавление текущему `game_mode`, который и определяет команду.
-   **`assign_player_to_team(self, player_id: str, team_id: str) -> bool`**:
    -   Предоставляет внешний интерфейс для ручного назначения игрока в команду.
    -   Проверяет, есть ли у текущего `game_mode` метод `assign_player_to_team` (что характерно для `CaptureTheFlagMode`) и вызывает его.

## 4. Отображение Информации о Командах в Состоянии Игры

Метод `get_state()` в `GameModeService` (и, следовательно, в `GameService`) включает информацию о командах:

```json
{
  // ... другие поля состояния ...
  "teams": {
    "team_1": {
      "players": ["player_id_1", "player_id_2"],
      "score": 0 // Текущий счет команды (логика подсчета специфична для режима)
    },
    "team_2": {
      "players": ["player_id_3"],
      "score": 0
    }
  },
  // ...
}
```

Каждый игрок в данных `players` также имеет поле `teamId`:
```json
{
  "players": {
    "player_id_1": {
      // ... другие поля игрока ...
      "teamId": "team_1"
    }
  }
}
```

Метод `GameService.get_teams()` также предоставляет структурированную информацию о командах и их составе.

## 5. Ключевые Моменты и Соображения

-   **Гибкость Режимов**: Основная логика определения команд и распределения игроков инкапсулирована в конкретных реализациях `GameModeService`, что позволяет легко добавлять новые режимы с уникальными правилами команд.
-   **Настройка `team_count`**: Этот параметр из `GameSettings` в основном влияет на режимы, где количество команд не определяется динамически (например, `CaptureTheFlagMode` до реализации привязки к карте). В `CampaignMode` он игнорируется (всегда 1 команда), а в `FreeForAllMode` количество команд равно количеству игроков.
-   **Балансировка Команд**: В `CaptureTheFlagMode` есть базовая логика автоматического назначения в команду с наименьшим числом игроков для поддержания баланса.
-   **Отсутствие "Лобби" для Выбора Команды**: В текущей реализации нет явного механизма выбора команды игроком перед началом игры через NATS-события. Назначение либо автоматическое, либо (для `CaptureTheFlagMode`) может быть изменено через `assign_player_to_team`, если для этого будет создан соответствующий NATS-обработчик или HTTP эндпоинт.

Эта система обеспечивает базовую, но расширяемую функциональность для управления командами в различных игровых сценариях. 