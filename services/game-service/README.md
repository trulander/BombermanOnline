# Сервис Игр (Game Service)

Сервис Игр является ключевым компонентом платформы Bomberman Online, отвечающим за всю логику игрового процесса. Он управляет созданием игр, подключением игроков, обработкой игровых событий, обновлением состояния игры и взаимодействием с другими сервисами.

## Основные возможности

-   Создание и настройка игровых сессий.
-   Поддержка различных игровых режимов (Кампания, Все против всех, Захват флага).
-   Управление игроками, их состоянием и вводом.
-   Обработка использования оружия (бомбы, пули, мины).
-   Генерация и управление картами, включая загрузку из шаблонов и цепочек.
-   Управление врагами (AI) и их поведением.
-   Система усилений (Power-ups).
-   Взаимодействие через NATS для асинхронной обработки событий.
-   REST API для управления шаблонами карт.
-   Хранение данных о картах в PostgreSQL и кеширование в Redis.

## Технологии

-   **Язык программирования:** Python 3.12
-   **Фреймворк:** FastAPI
-   **База данных:** PostgreSQL (для хранения карт)
-   **Кеш:** Redis (для кеширования данных карт)
-   **Система обмена сообщениями:** NATS
-   **ORM/Query Builder:** SQLAlchemy (асинхронный)
-   **Управление зависимостями и сборка:** UV
-   **Миграции базы данных:** Alembic
-   **Контейнеризация:** Docker
-   **Логирование:** python-json-logger

## Установка зависимостей

Для установки зависимостей используется менеджер пакетов `uv`.

1.  Убедитесь, что у вас установлен `uv`. Если нет, установите его:
    ```bash
    pip install uv
    ```
2.  Создайте и активируйте виртуальное окружение (рекомендуется):
    ```bash
    python -m venv .venv
    source .venv/bin/activate  # для Linux/macOS
    # .venv\Scripts\activate    # для Windows
    ```
3.  Установите зависимости из `pyproject.toml` (находясь в директории `services/game-service`):
    ```bash
    uv pip install .
    # или, если нужны dev-зависимости и для редактируемой установки:
    # uv pip install -e ".[dev]"
    ```

## Запуск сервиса

### Локальный запуск (для разработки)

1.  Убедитесь, что запущены все необходимые сервисы: PostgreSQL, Redis, NATS. Конфигурация подключения к ним находится в файле `.env` (создайте его из `.env-example` при необходимости в директории `services/game-service`).
2.  Примените миграции базы данных:
    Из директории `services/game-service`:
    ```bash
    uv run python app/manage.py migrate
    ```
3.  Запустите FastAPI приложение с помощью Uvicorn:
    Из директории `services/game-service`:
    ```bash
    uv run uvicorn app.main:app --host 0.0.0.0 --port 5002 --reload
    ```
    Сервис будет доступен по адресу `http://localhost:5002`. Документация API (Swagger UI) будет доступна по адресу `http://localhost:5002/games/docs`.

### Запуск с использованием Docker

1.  **Сборка Docker-образа:**
    Находясь в директории `services/game-service`, выполните:
    ```bash
    docker build -t bomberman-game-service .
    ```
2.  **Запуск Docker-контейнера:**
    (Пример, требует наличия запущенных PostgreSQL, Redis, NATS и соответствующей конфигурации сети Docker. Переменные окружения можно передать через `-e` или файл)
    ```bash
    docker run -p 5002:5002 \
           --env-file .env \ # Убедитесь, что .env файл настроен для Docker-окружения
           bomberman-game-service
    ```
    Для полноценного запуска через Docker рекомендуется использовать `docker-compose.yml` из корневой директории проекта, который управляет всеми сервисами и их конфигурациями.

## Переменные окружения

Сервис настраивается с помощью переменных окружения. Пример файла с переменными окружения можно найти в `services/game-service/.env-example`. Основные переменные:

-   `API_V1_STR`: Префикс для API V1.
-   `HOST`, `PORT`: Хост и порт для FastAPI.
-   `DEBUG`, `RELOAD`: Флаги отладки и перезагрузки для Uvicorn.
-   `POSTGRES_HOST`, `POSTGRES_PORT`, `POSTGRES_DB`, `POSTGRES_USER`, `POSTGRES_PASSWORD`: Настройки подключения к PostgreSQL.
-   `REDIS_HOST`, `REDIS_PORT`, `REDIS_DB`, `REDIS_PASSWORD`: Настройки подключения к Redis.
-   `NATS_URL`: URL для подключения к NATS.
-   `LOG_LEVEL`, `LOG_FORMAT`, `TRACE_CALLER`: Настройки логирования.
-   `GAME_UPDATE_FPS`: Частота обновления игрового цикла (кадров в секунду).

Полный список и значения по умолчанию смотрите в `app/config.py`.

## Структура проекта

-   `app/`: Основной код приложения.
    -   `alembic/`: Миграции базы данных Alembic.
    -   `auth.py`: Функции для аутентификации/авторизации.
    -   `coordinators/`: Координаторы, управляющие сложной логикой (например, `GameCoordinator`).
    -   `entities/`: Классы, представляющие игровые сущности.
    -   `main.py`: Точка входа FastAPI приложения, инициализация.
    -   `manage.py`: CLI для управления (например, миграциями).
    -   `models/`: Pydantic модели для API и SQLAlchemy ORM модели.
    -   `repositories/`: Классы для доступа к данным.
    -   `routes/`: API эндпоинты.
    -   `services/`: Бизнес-логика, игровые режимы.
    -   `config.py`: Конфигурация приложения из переменных окружения.
    -   `logging_config.py`: Конфигурация логирования.
-   `docs/`: Детальная документация по сервису.
-   `Dockerfile`: Инструкции для сборки Docker-образа.
-   `pyproject.toml`: Описание проекта и его зависимостей.
-   `README.md`: Этот файл.
-   `.env-example`: Пример файла с переменными окружения.

## Дополнительная документация

Более подробную информацию о компонентах сервиса, API, событиях и архитектуре можно найти в директории [docs](./docs/).