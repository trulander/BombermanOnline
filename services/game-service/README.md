# Сервис Игр (Game Service)

Сервис Игр является ключевым компонентом платформы Bomberman Online, отвечающим за всю логику игрового процесса. Он управляет созданием игр, подключением игроков, обработкой игровых событий, обновлением состояния игры и взаимодействием с другими сервисами.

## Основные возможности

-   **Управление игровыми сессиями:** Создание, настройка, запуск, пауза и завершение игр через REST API.
-   **Поддержка игровых режимов:** Кампания, Все против всех, Захват флага с настраиваемыми параметрами.
-   **Управление игроками:** Добавление/удаление игроков, управление их состоянием и обработка ввода.
-   **Командная система:** Создание команд, автоматическое распределение игроков, система очков.
-   **Боевая система:** Использование различных видов оружия (бомбы, пули, мины).
-   **Управление картами:** Генерация случайных карт, загрузка из шаблонов и цепочек через REST API.
-   **Искусственный интеллект:** Управление врагами и их поведением.
-   **Система усилений:** Power-ups для улучшения характеристик игроков.
-   **Реальное время:** Взаимодействие через NATS для асинхронной обработки игровых событий.
-   **REST API:** Полноценное управление играми, командами и картами.
-   **Персистентность:** Хранение данных о картах в PostgreSQL и кеширование в Redis.

## Технологии

-   **Язык программирования:** Python 3.12
-   **Фреймворк:** FastAPI
-   **База данных:** PostgreSQL (для хранения карт)
-   **Кеш:** Redis (для кеширования данных карт)
-   **Система обмена сообщениями:** NATS
-   **ORM/Query Builder:** SQLAlchemy (асинхронный)
-   **Управление зависимостями и сборка:** UV
-   **Миграции базы данных:** Alembic
-   **Контейнеризация:** Docker
-   **Логирование:** python-json-logger

## Установка зависимостей

Для установки зависимостей используется менеджер пакетов `uv`.

1.  Убедитесь, что у вас установлен `uv`. Если нет, установите его:
    ```bash
    pip install uv
    ```
2.  Создайте и активируйте виртуальное окружение (рекомендуется):
    ```bash
    python -m venv .venv
    source .venv/bin/activate  # для Linux/macOS
    # .venv\Scripts\activate    # для Windows
    ```
3.  Установите зависимости из `pyproject.toml` (находясь в директории `services/game-service`):
    ```bash
    uv pip install .
    # или, если нужны dev-зависимости и для редактируемой установки:
    # uv pip install -e ".[dev]"
    ```

## Запуск сервиса

### Локальный запуск (для разработки)

1.  Убедитесь, что запущены все необходимые сервисы: PostgreSQL, Redis, NATS. Конфигурация подключения к ним находится в файле `.env` (создайте его из `.env-example` при необходимости в директории `services/game-service`).
2.  Примените миграции базы данных:
    Из директории `services/game-service`:
    ```bash
    uv run python app/manage.py migrate
    ```
3.  Запустите FastAPI приложение с помощью Uvicorn:
    Из директории `services/game-service`:
    ```bash
    uv run uvicorn app.main:app --host 0.0.0.0 --port 5002 --reload
    ```
    Сервис будет доступен по адресу `http://localhost:5002`. Документация API (Swagger UI) будет доступна по адресу `http://localhost:5002/games/docs`.

### API Endpoints

Сервис предоставляет следующие группы REST API endpoints:

-   **Игры (`/games/api/v1/games`):**
    -   `GET /` - Получить список игр с фильтрацией
    -   `GET /{game_id}` - Получить детальную информацию об игре
    -   `POST /` - Создать новую игру
    -   `PUT /{game_id}/settings` - Обновить настройки игры
    -   `PUT /{game_id}/status` - Изменить статус игры (start/pause/resume)
    -   `POST /{game_id}/players` - Добавить игрока в игру
    -   `DELETE /{game_id}/players/{player_id}` - Удалить игрока из игры
    -   `DELETE /{game_id}` - Удалить игру

-   **Команды (`/games/api/v1/teams`):**
    -   `GET /{game_id}` - Получить команды игры
    -   `POST /{game_id}` - Создать команду
    -   `PUT /{game_id}/{team_id}` - Обновить команду
    -   `DELETE /{game_id}/{team_id}` - Удалить команду
    -   `POST /{game_id}/{team_id}/players` - Добавить игрока в команду
    -   `DELETE /{game_id}/{team_id}/players/{player_id}` - Удалить игрока из команды
    -   `POST /{game_id}/distribute` - Автоматически распределить игроков по командам

-   **Карты (`/games/api/v1/maps`):**
    -   `POST /templates` - Создать шаблон карты
    -   `GET /templates` - Получить список шаблонов карт
    -   `GET /templates/{id}` - Получить шаблон карты
    -   `PUT /templates/{id}` - Обновить шаблон карты
    -   `DELETE /templates/{id}` - Удалить шаблон карты
    -   Аналогичные операции для групп (`/groups`) и цепочек (`/chains`) карт

Подробную документацию по API можно найти в [docs/api_endpoints.md](./docs/api_endpoints.md).

### Запуск с использованием Docker

1.  **Сборка Docker-образа:**
    Находясь в директории `services/game-service`, выполните:
    ```bash
    docker build -t bomberman-game-service .
    ```
2.  **Запуск Docker-контейнера:**
    (Пример, требует наличия запущенных PostgreSQL, Redis, NATS и соответствующей конфигурации сети Docker. Переменные окружения можно передать через `-e` или файл)
    ```bash
    docker run -p 5002:5002 \
           --env-file .env \ # Убедитесь, что .env файл настроен для Docker-окружения
           bomberman-game-service
    ```
    Для полноценного запуска через Docker рекомендуется использовать `docker-compose.yml` из корневой директории проекта, который управляет всеми сервисами и их конфигурациями.

## Переменные окружения

Сервис настраивается с помощью переменных окружения. Пример файла с переменными окружения можно найти в `services/game-service/.env-example`. Основные переменные:

-   `API_V1_STR`: Префикс для API V1.
-   `HOST`, `PORT`: Хост и порт для FastAPI.
-   `DEBUG`, `RELOAD`: Флаги отладки и перезагрузки для Uvicorn.
-   `POSTGRES_HOST`, `POSTGRES_PORT`, `POSTGRES_DB`, `POSTGRES_USER`, `POSTGRES_PASSWORD`: Настройки подключения к PostgreSQL.
-   `REDIS_HOST`, `REDIS_PORT`, `REDIS_DB`, `REDIS_PASSWORD`: Настройки подключения к Redis.
-   `NATS_URL`: URL для подключения к NATS.
-   `LOG_LEVEL`, `LOG_FORMAT`, `TRACE_CALLER`: Настройки логирования.
-   `GAME_UPDATE_FPS`: Частота обновления игрового цикла (кадров в секунду).

Полный список и значения по умолчанию смотрите в `app/config.py`.

## Структура проекта

-   `app/`: Основной код приложения.
    -   `alembic/`: Миграции базы данных Alembic.
    -   `auth.py`: Функции для аутентификации/авторизации.
    -   `coordinators/`: Координаторы, управляющие сложной логикой (например, `GameCoordinator`).
    -   `entities/`: Классы, представляющие игровые сущности.
    -   `main.py`: Точка входа FastAPI приложения, инициализация.
    -   `manage.py`: CLI для управления (например, миграциями).
    -   `models/`: Pydantic модели для API и SQLAlchemy ORM модели.
    -   `repositories/`: Классы для доступа к данным.
    -   `routes/`: API эндпоинты.
    -   `services/`: Бизнес-логика, игровые режимы.
    -   `config.py`: Конфигурация приложения из переменных окружения.
    -   `logging_config.py`: Конфигурация логирования.
-   `docs/`: Детальная документация по сервису.
-   `Dockerfile`: Инструкции для сборки Docker-образа.
-   `pyproject.toml`: Описание проекта и его зависимостей.
-   `README.md`: Этот файл.
-   `.env-example`: Пример файла с переменными окружения.

## Дополнительная документация

Более подробную информацию о компонентах сервиса, API, событиях и архитектуре можно найти в директории [docs](./docs/).