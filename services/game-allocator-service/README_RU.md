# Сервис распределения игр (Game Allocator Service)
[![English](https://img.shields.io/badge/lang-English-blue)](README.md)

Сервис распределения игр отвечает за эффективное распределение игровых сессий по доступным экземплярам игровых серверов. Он использует метрики загрузки (CPU и RAM) игровых серверов, полученные из Prometheus, и консультируется с Consul для обнаружения здоровых экземпляров. Сервис взаимодействует через NATS для получения запросов на распределение игр и для публикации результатов.

## Назначение сервиса

Основная задача `game-allocator-service` — обеспечить балансировку нагрузки и оптимальное использование ресурсов игровых серверов путем интеллектуального выбора наименее загруженного экземпляра для новой игровой сессии. Это критически важно для поддержания стабильной производительности и минимизации задержек в многопользовательской игре.

## Используемые технологии

*   **Python 3.9**: Язык программирования.
*   **`asyncio`**: Асинхронный ввод/вывод для высокопроизводительных сетевых операций.
*   **NATS**: Легковесная, высокопроизводительная система обмена сообщениями, используемая для асинхронного взаимодействия между микросервисами.
*   **Prometheus API Client (`prometheus-api-client`)**: Для программного запроса метрик загрузки с Prometheus.
*   **Consul (`py-consul`)**: Для обнаружения сервисов и получения списка здоровых экземпляров игровых серверов.
*   **Redis (`redis`)**: Используется как кэш для хранения информации о распределенных игровых экземплярах (GameInstanceCache).
*   **Pydantic (`pydantic`, `pydantic-settings`)**: Для валидации данных и управления настройками конфигурации.
*   **Python JSON Logger (`python-json-logger`)**: Для структурированного логирования.
*   **UV**: Менеджер пакетов Python, используемый для установки зависимостей.

## Структура проекта

```
services/game-allocator-service/
├── app/
│   ├── __init__.py
│   ├── config.py             # Конфигурационные настройки сервиса
│   ├── game_cache.py         # Логика кэширования игровых экземпляров в Redis
│   ├── logging_config.py     # Конфигурация логирования
│   ├── main.py               # Основная логика сервиса и точка входа
│   ├── nats_repository.py    # Взаимодействие с NATS
│   └── redis_repository.py   # Взаимодействие с Redis
├── Dockerfile                # Определение Docker образа для сервиса
├── pyproject.toml            # Управление зависимостями проекта (через Poetry/uv)
├── README.md                 # Общие сведения о сервисе
└── uv.lock                   # Файл блокировки зависимостей uv
```

## NATS-события и API-эндпоинты

Сервис `game-allocator-service` в основном взаимодействует через NATS-события. Он подписывается на запросы и публикует ответы.

### Запросы

*   **`game.assign.request`**:
    *   **Описание**: Запрос на распределение новой игровой сессии на игровой сервер.
    *   **Отправитель**: Обычно `webapi-service` или другой сервис, инициирующий новую игру.
    *   **Payload (JSON)**:

        ```json
        {
            "game_id": "<ID игры>",
            "settings": {
                "resource_level": "low" | "high" // Определяет, учитывать ли CPU (low) или RAM (high) при выборе сервера
            }
        }
        ```

### Ответы

После обработки запроса `game.assign.request`, сервис публикует ответ на тему, указанную в `msg.reply` NATS-сообщения.

*   **Payload (JSON)**:

    ```json
    {
        "success": true | false,
        "instance_id": "<IP-адрес или ID экземпляра игрового сервера>" // При успешном распределении
    }
    ```

## Взаимодействие с другими сервисами

*   **Consul**: Используется для обнаружения всех зарегистрированных экземпляров `game-service` и проверки их работоспособности.
*   **Prometheus**: Запрашивает метрики загрузки (CPU, RAM) для каждого экземпляра `game-service` для принятия решения о распределении.
*   **Redis**: Используется как кэш для временного хранения связи между `game_id` и `instance_id` (IP-адресом игрового сервера).
*   **NATS**: Основной канал связи для получения запросов на распределение игр и отправки ответов.
*   **Game Service**: Является целевым сервисом, на который `game-allocator-service` распределяет игры. Взаимодействие непрямое, через Consul и Prometheus для мониторинга, и через NATS для уведомлений (хотя в текущей версии NATS-уведомления закомментированы).

## Переменные окружения

Конфигурация сервиса управляется через переменные окружения, определенные в `app/config.py`.

*   `SERVICE_NAME`: Имя сервиса, по умолчанию `game-allocator-service`.
*   `APP_TITLE`: Заголовок приложения, по умолчанию `Bomberman Game Allocator Service`.
*   `GAME_CACHE_TTL`: Время жизни кэша для игровых экземпляров в секундах, по умолчанию `60`.
*   `REDIS_HOST`: Хост Redis, по умолчанию `localhost`.
*   `REDIS_PORT`: Порт Redis, по умолчанию `6379`.
*   `REDIS_DB`: База данных Redis, по умолчанию `0`.
*   `REDIS_PASSWORD`: Пароль для Redis (опционально).
*   `NATS_URL`: URL NATS сервера, по умолчанию `nats://localhost:4222`.
*   `PROMETHEUS_URL`: URL Prometheus сервера, по умолчанию `http://prometheus:9090`.
*   `CONSUL_HOST`: Хост Consul, по умолчанию `consul`.
*   `LOG_LEVEL`: Уровень логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL), по умолчанию `DEBUG`.
*   `LOG_FORMAT`: Формат логирования (`text` или `json`), по умолчанию `text`.
*   `TRACE_CALLER`: Включать ли информацию о вызывающей стороне в логи, по умолчанию `True`.

## Инструкции по запуску и развертыванию

### Локальный запуск (с Docker Compose)

1.  **Убедитесь, что Docker и Docker Compose установлены.**
2.  **Запустите все необходимые инфраструктурные сервисы через Docker Compose**: Перейдите в корневую директорию проекта (`BombermanOnline`) и выполните:
    ```bash
    docker-compose -f infra/docker-compose.yml up -d
    ```
    Это запустит Consul, Prometheus, NATS, Redis и другие сервисы, от которых зависит `game-allocator-service`.
3.  **Соберите и запустите `game-allocator-service`**: Перейдите в директорию сервиса:
    ```bash
    cd services/game-allocator-service
    ```
    Затем соберите Docker образ и запустите контейнер. В `Dockerfile` используется `uv` для установки зависимостей и запуска приложения.
    ```bash
    docker build -t game-allocator-service .
    docker run --network bombermanonline_default game-allocator-service
    ```
    *(Примечание: Сеть `bombermanonline_default` создается при запуске `infra/docker-compose.yml`)*

### Запуск в режиме разработки (без Docker)

1.  **Установите Python 3.9 и UV.**
2.  **Установите зависимости**: Перейдите в директорию `services/game-allocator-service` и выполните:
    ```bash
    uv sync
    ```
3.  **Запустите сервис**: Убедитесь, что все необходимые внешние сервисы (Consul, Prometheus, NATS, Redis) запущены и доступны с вашего хоста. Затем запустите:
    ```bash
    uv run app/main.py
    ```

### Развертывание

Сервис предназначен для развертывания в контейнерной среде (например, Docker, Kubernetes). `Dockerfile` предоставляет все необходимое для создания переносимого образа. Важно убедиться, что переменные окружения настроены правильно для производственной среды, особенно `CONSUL_HOST`, `PROMETHEUS_URL`, `NATS_URL`, `REDIS_HOST`. 