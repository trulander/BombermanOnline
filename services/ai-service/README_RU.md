# AI Сервис (AI Service)
[![English](https://img.shields.io/badge/lang-English-blue)](README.md)

AI Сервис является новым компонентом платформы Bomberman Online, отвечающим за управление юнитами (врагами и игроками с AI) в игровых сессиях, а также за обучение моделей искусственного интеллекта.

## Назначение сервиса

`AI Service` будет симулировать поведение AI-управляемых сущностей в игровом мире. Он будет принимать текущее состояние игры, принимать решения и отправлять команды обратно в `Game Service`. Кроме того, сервис будет предоставлять функционал для тренировки новых моделей AI с использованием Reinforcement Learning.

## Используемые технологии

*   **Python 3.12**: Основной язык программирования.
*   **FastAPI**: Для потенциальных API-эндпоинтов (хотя основное взаимодействие будет через NATS).
*   **NATS (`nats-py`)**: Для асинхронного взаимодействия с `Game Service` (получение обновлений состояния игры и отправка команд AI).
*   **Redis (`redis`)**: Возможное использование для кэширования метаданных моделей или параметров обучения.
*   **Gymnasium**: Для создания и управления средой обучения AI.
*   **Stable-Baselines3**: Для реализации алгоритмов обучения с подкреплением (Reinforcement Learning), таких как PPO, A2C.
*   **TensorBoard**: Для визуализации процесса обучения и метрик моделей.
*   **Pydantic**: Для валидации данных и управления конфигурацией.
*   **Numpy**: Для эффективной работы с данными.
*   **Python JSON Logger**: Для структурированного логирования.

## Структура проекта

```
services/ai-service/
├── app/
│   ├── __init__.py
│   ├── main.py                   # Точка входа FastAPI приложения
│   ├── config.py                 # Конфигурационные настройки сервиса
│   ├── nats_controller.py        # Обработка NATS-событий
│   ├── repositories/             # Репозитории для взаимодействия с NATS и Redis
│   │   ├── nats_repository.py
│   │   └── redis_repository.py
│   ├── entities/                 # Pydantic-модели для представления состояния игры
│   │   └── game_state_representation.py
│   ├── environment/              # Среда Gymnasium для обучения AI
│   │   └── bomberman_env.py
│   ├── agents/                   # Реализации AI-агентов
│   │   ├── base_agent.py
│   │   ├── bomberman_ai_agent.py
│   │   └── enemy_ai_agent.py
│   └── training/                 # Логика для тренировки моделей
│       ├── model_manager.py      # Управление сохранением/загрузкой моделей
│       └── trainer.py            # Логика запуска тренировки
├── Dockerfile                    # Определение Docker образа
├── pyproject.toml                # Управление зависимостями
└── README.md                     # Этот файл
```

## Взаимодействие с другими сервисами

*   **Game Service**: Основной сервис, с которым взаимодействует `AI Service`.
    *   **Получение состояния игры**: `AI Service` подписывается на события `game.update.<game_id>` от `Game Service` для получения инкрементальных обновлений состояния игры. Для получения полного начального состояния, `AI Service` будет отправлять NATS-запрос `game.get_state.<game_id>` в `Game Service`.
    *   **Отправка команд AI**: `AI Service` будет публиковать события `game.input.<game_id>` и `game.place_weapon.<game_id>` в `Game Service`, чтобы управлять AI-юнитами.
    *   **Уведомления о сущностях**: `Game Service` будет уведомлять `AI Service` о появлении (`ai.entity_spawn`) и исчезновении (`ai.entity_despawn`) AI-управляемых сущностей.

## Запуск сервиса

### Локальный запуск (для разработки)

1.  **Установка зависимостей**:
    Перейдите в директорию `services/ai-service` и выполните:
    ```bash
    uv sync
    ```

2.  **Запуск приложения**:
    Убедитесь, что все необходимые внешние сервисы (NATS, Redis) запущены и доступны с вашего хоста.
    ```bash
    uvicorn app.main:app --host 0.0.0.0 --port 5004 --reload
    ```
    Сервис будет доступен по адресу `http://localhost:5004` (если будет определен HTTP API).

### Запуск с использованием Docker Compose (Рекомендуется)

Для комплексного развертывания со всеми зависимыми сервисами, используйте корневой `docker-compose.yml` проекта.

1.  **Сборка Docker-образа**:
    Находясь в директории `services/ai-service`, выполните:
    ```bash
    docker build -t bomberman-ai-service .
    ```
2.  **Запуск Docker-контейнера**:
    (Пример, требует наличия запущенных NATS, Redis и соответствующей конфигурации сети Docker).
    ```bash
    docker run -p 5004:5004 \
           --env-file .env \ # Убедитесь, что .env файл настроен для Docker-окружения
           -v ../infra/ai_models:/app/ai_models \
           -v ../infra/ai_logs:/app/ai_logs \
           bomberman-ai-service
    ```
    Для полноценного запуска через Docker Compose, сервис `ai-service` должен быть добавлен в `infra/docker-compose.yml`.

## Тренировка моделей AI

### Сохранение и загрузка моделей

Модели будут сохраняться в директорию `infra/ai_models/` на хост-машине. Каждая модель будет иметь имя, связанное с игровым режимом, и номер итерации, что позволит возобновлять тренировку с определенной точки.

### Мониторинг с TensorBoard

Логи TensorBoard будут сохраняться в директорию `infra/ai_logs/` на хост-машине.
Для просмотра прогресса тренировки запустите TensorBoard:

```bash
tensorboard --logdir=./infra/ai_logs --host 0.0.0.0 --port 6006
```
Затем откройте в браузере `http://localhost:6006`.

## Переменные окружения

Конфигурация сервиса осуществляется через следующие переменные окружения. Значения по умолчанию указаны в `app/config.py`.

| Переменная          | Описание                                                            | Значение по умолчанию (`app/config.py`) |
| :------------------ | :------------------------------------------------------------------ | :------------------------------------- |
| `SERVICE_NAME`      | Имя сервиса.                                                        | `ai-service`                           |
| `HOST`              | Хост, на котором запускается FastAPI приложение.                    | `0.0.0.0`                              |
| `PORT`              | Порт, на котором запускается FastAPI приложение.                    | `5004`                                 |
| `DEBUG`             | Включает режим отладки FastAPI.                                     | `True`                                 |
| `RELOAD`            | Включает автоматическую перезагрузку Uvicorn.                       | `True`                                 |
| `REDIS_HOST`        | Хост для подключения к Redis.                                       | `localhost`                            |
| `REDIS_PORT`        | Порт для подключения к Redis.                                       | `6379`                                 |
| `REDIS_DB`          | Номер базы данных Redis.                                            | `0`                                    |
| `REDIS_PASSWORD`    | Пароль для подключения к Redis (если требуется).                    | `None`                                 |
| `NATS_URL`          | URL NATS сервера.                                                   | `nats://localhost:4222`                |
| `LOG_LEVEL`         | Уровень логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL).        | `INFO`                                 |
| `LOG_FORMAT`        | Формат логов (`text` или `json`).                                   | `json`                                 |
| `TRACE_CALLER`      | Включает ли добавление информации о вызывающих функциях в JSON логи. | `True`                                 |
| `MODELS_PATH`       | Путь к директории для сохранения моделей AI.                        | `/app/ai_models`                       |
| `LOGS_PATH`         | Путь к директории для логов TensorBoard.                            | `/app/ai_logs`                         | 