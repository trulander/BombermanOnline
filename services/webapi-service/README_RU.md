# WebAPI Service
[![English](https://img.shields.io/badge/lang-English-blue)](README.md)

Этот документ описывает сервис WebAPI для Bomberman Online. Он служит центральной точкой входа для клиентских приложений, предоставляя RESTful API и WebSocket-соединения для игровых взаимодействий.

## 1. Назначение сервиса

`WebAPI Service` выполняет роль шлюза между клиентскими приложениями (веб-фронтенд) и внутренними микросервисами (`Auth Service`, `Game Allocator Service`, `Game Service`). Его ключевые функции включают:

*   **Предоставление RESTful API**: Для управления игровыми комнатами (создание, получение списка).
*   **Управление WebSocket-соединениями**: Использование Socket.IO для поддержания постоянных соединений с клиентами, что необходимо для обмена игровыми событиями в реальном времени.
*   **Проксирование запросов**: Перенаправление определенных запросов от клиентов к соответствующим экземплярам `Game Service`.
*   **Взаимодействие с NATS**: Публикация команд от клиентов в NATS и подписка на обновления игрового состояния из NATS, которые затем пересылаются клиентам через WebSocket.
*   **Кеширование состояния игры**: Хранение информации об активных игровых сессиях (например, адрес `Game Service`), чтобы быстро направлять запросы к нужному экземпляру.
*   **Метрики**: Предоставление метрик для мониторинга.

## 2. Используемые технологии

Сервис разработан на Python с использованием следующих ключевых технологий:

*   **FastAPI**: Современный, быстрый (высокопроизводительный) веб-фреймворк для создания API на Python.
*   **Uvicorn**: ASGI-сервер для запуска асинхронных Python-приложений.
*   **Python-SocketIO**: Библиотека для реализации WebSocket-коммуникации с использованием протокола Socket.IO.
*   **NATS.py**: Клиентская библиотека для взаимодействия с высокопроизводительной распределенной системой обмена сообщениями NATS.
*   **Redis**: Используется как хранилище для кеширования информации об активных игровых сессиях.
*   **HTTPLX**: Асинхронный HTTP-клиент для проксирования запросов к `Game Service`.
*   **Py-Consul**: Клиентская библиотека для взаимодействия с Consul, используемая для обнаружения сервисов (в контексте `Game Allocator Service` для получения адресов игровых сервисов).
*   **Aioprometheus**: Инструментарий для предоставления метрик в формате Prometheus.

## 3. API-эндпоинты

Все API-эндпоинты имеют префикс `/api/v1`.

### 3.1. Корневой эндпоинт (`/`)

*   `GET /`: Отображает простую HTML-страницу с приветствием и ссылкой на документацию Swagger UI (`/docs`).

### 3.2. Эндпоинты для игр (`/api/v1/games`)

*   `POST /api/v1/games/`
    *   **Описание**: Создание новой игровой сессии. Отправляет команду `game.create` в NATS, ожидая ответа от `Game Allocator Service` или `Game Service`.
    *   **Тело запроса (Request Body)**: `GameCreateSettings` (JSON), содержащий параметры для новой игры (игровой режим, максимальное количество игроков, ID карты и т.д.).
    *   **Ответ**: `Dict`, содержащий `success: bool` и `game_id: str` (если успешно) или `message: str` (при ошибке).

### 3.3. Прокси-эндпоинты для Game Service (`/api/v1/game-service/{game_id}/{path:path}`)

Эти эндпоинты служат для проксирования всех HTTP-запросов к соответствующему экземпляру `Game Service`, основываясь на `game_id`. URL-путь после `/game-service/{game_id}/` полностью передается в `Game Service`.

*   `GET /api/v1/game-service/{game_id}/{path:path}`
*   `POST /api/v1/game-service/{game_id}/{path:path}`
*   `PUT /api/v1/game-service/{game_id}/{path:path}`
*   `DELETE /api/v1/game-service/{game_id}/{path:path}`
*   `OPTIONS /api/v1/game-service/{game_id}/{path:path}`
*   `HEAD /api/v1/game-service/{game_id}/{path:path}`
*   `PATCH /api/v1/game-service/{game_id}/{path:path}`
*   `TRACE /api/v1/game-service/{game_id}/{path:path}`

    *   **Описание**: Универсальный прокси-эндпоинт, который перенаправляет любой HTTP-запрос (с сохранением метода, заголовков, параметров запроса и тела) к динамически найденному адресу `Game Service` для указанного `game_id`.
    *   **Механизм**: Использует `GameInstanceCache` для получения IP-адреса и порта `Game Service`, ассоциированного с `game_id`. Если адрес не найден, возвращает `404 Not Found`. Если `Game Service` недоступен, возвращает `503 Service Unavailable`.
    *   **Параметры пути**: `game_id` (уникальный идентификатор игры), `path` (оставшаяся часть пути, передаваемая в `Game Service`).
    *   **Ответ**: Ответ, полученный от `Game Service`.

## 4. Внутренняя архитектура

`WebAPI Service` организован по модульному принципу:

### 4.1. Основной файл (`app/main.py`)

*   Инициализирует FastAPI приложение и Socket.IO сервер.
*   Настраивает CORS, логирование и метрики Prometheus.
*   Регистрирует роутеры (`root_router`, `api_router`).
*   Определяет `startup` и `shutdown` события для подключения/отключения к Redis, NATS и `GameInstanceCache`.
*   Содержит логику обработки Socket.IO событий (`connect`, `disconnect`, `join_game`, `game_input`, `place_weapon`, `get_game_state`). Эти обработчики взаимодействуют с `GameService` (собственный сервис `WebAPI` для оркестрации NATS-коммуникации) для отправки команд в NATS и получения ответов.

### 4.2. Роуты (`app/routes/`)

*   `root.py`: Корневой маршрут `/`.
*   `api.py`: Агрегирует маршруты `api_v1` под префиксом `/api/v1`.
*   `api_v1/game_routes.py`: Содержит эндпоинт `POST /games/` для создания игр.
*   `api_v1/proxy_routes.py`: Реализует универсальный прокси-функционал для перенаправления запросов в `Game Service`.

### 4.3. Сервисы (`app/services/`)

*   `game_service.py`: **Важный компонент** в `WebAPI Service`. Это не `Game Service` как таковой, а сервис-оркестратор, который:
    *   Использует `NatsService` для отправки команд в `Game Service` (например, `game.create`, `game.join`, `game.input`) и получения ответов.
    *   Использует `GameInstanceCache` для получения адресов игровых сервисов.
    *   Предоставляет методы для высокоуровневых операций, таких как `create_game`, `join_game`, `send_game_input`, `place_weapon`, `get_game_state`, `disconnect_player`.
*   `nats_service.py`: Обертка над `NatsRepository`, предоставляющая методы для публикации и подписки на специфические NATS-события, используемые `WebAPI Service` (например, подписка на `game.update.{game_id}`).
*   `socketio_service.py`: Управляет WebSocket-соединениями через Socket.IO. Отвечает за отправку игровых обновлений (`game.update`) клиентам и управление комнатами Socket.IO.
*   `game_cache.py`: **Кеширование адресов игровых сервисов**. Использует `RedisRepository` и `ConsulService`:
    *   `get_instance(game_id: str)`: Пытается получить адрес `Game Service` для `game_id` из Redis. Если нет, запрашивает у `Game Allocator Service` через NATS (`game.allocate`), кеширует результат и возвращает его.
    *   `release_instance(game_id: str)`: Удаляет запись из кеша Redis.
*   `metrics_socket_server.py`: Сервис для сбора и публикации метрик через WebSocket (потенциально).

### 4.4. Репозитории (`app/repositories/`)

*   `redis_repository.py`: Абстракция для работы с Redis (set, get, delete) для кеширования данных.
*   `nats_repository.py`: Абстракция для низкоуровневого взаимодействия с NATS (publish, subscribe).

### 4.5. Модели (`app/models/`)

*   `game.py`: Pydantic модели для запросов и ответов, связанных с играми (например, `JoinGameRequest`, `GameCreateSettings`).

### 4.6. Сущности (`app/entities/`)

*   `game_mode.py`: Содержит перечисление `GameModeType`.

### 4.7. Конфигурация (`app/config.py`)

*   Определяет глобальные настройки приложения, загружаемые из переменных окружения (порты, хосты баз данных, NATS URL, CORS настройки и т.д.).

### 4.8. Зависимости (`app/dependencies.py`)

*   Содержит функции-зависимости FastAPI, такие как `get_game_service`, `get_nats_service`, `get_redis_repository`, `get_game_cache`, которые обеспечивают инъекцию зависимостей в эндпоинты и другие сервисы.

### 4.9. Аутентификация (`app/auth.py`)

*   Содержит зависимости для проверки аутентификации пользователя на основе заголовков, полученных от вышестоящего шлюза (Traefik/Kong).

## 5. Переменные окружения

Конфигурация сервиса осуществляется через переменные окружения. Вот основные из них:

| Переменная                     | Описание                                                                 | По умолчанию (`app/config.py`)         |
| :----------------------------- | :----------------------------------------------------------------------- | :------------------------------------- |
| `API_V1_STR`                   | Префикс URL для всех API эндпоинтов V1.                                  | `/api/v1`                              |
| `APP_TITLE`                    | Заголовок приложения (для Swagger).
| `HOST`                         | Хост, на котором запускается FastAPI приложение.                         | `0.0.0.0`                              |
| `PORT`                         | Порт, на котором запускается FastAPI приложение.                         | `5001`                                 |
| `DEBUG`                        | Включает режим отладки FastAPI.                                          | `True`                                 |
| `RELOAD`                       | Включает автоматическую перезагрузку Uvicorn при изменениях кода.        | `True`                                 |
| `SWAGGER_URL`                  | URL для доступа к Swagger UI документации.                               | `/docs`                                |
| `CORS_ORIGINS`                 | Список разрешенных источников для CORS (через запятую или JSON список).  | `["*"]` (все источники)              |
| `CORS_CREDENTIALS`             | Разрешает ли CORS передачу credentials (например, cookie).               | `True`                                 |
| `CORS_METHODS`                 | Список разрешенных HTTP методов для CORS.                                | `["*"]` (все методы)                 |
| `CORS_HEADERS`                 | Список разрешенных HTTP заголовков для CORS.                             | `["*"]` (все заголовки)              |
| `REDIS_HOST`                   | Хост сервера Redis.                                                      | `localhost`                            |
| `REDIS_PORT`                   | Порт сервера Redis.                                                      | `6379`                                 |
| `REDIS_DB`                     | Номер базы данных Redis.                                                 | `0`                                    |
| `REDIS_PASSWORD`               | Пароль для подключения к Redis (если требуется).                         | `None`                                 |
| `NATS_URL`                     | URL для подключения к NATS серверу.                                      | `nats://localhost:4222`                |
| `LOG_LEVEL`                    | Уровень логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL).             | `INFO`                                 |
| `LOG_FORMAT`                   | Формат логов (`text` или `json`).                                        | `text`                                 |
| `TRACE_CALLER`                 | Включает ли добавление информации о вызывающих функциях в JSON логи.     | `True`                                 |
| `CONSUL_HOST`                  | Хост Consul для обнаружения сервисов.                                    | `localhost`                            |
| `CONSUL_PORT`                  | Порт Consul.                                                             | `8500`                                 |
| `SERVICE_REGISTRY_URL`         | URL для регистрации сервисов (не используется напрямую, но присутствует).| `http://localhost:8500`                |
| `REDIS_CACHE_TTL`              | Время жизни кеша Redis для адресов Game Service (в секундах).            | `3600` (1 час)                         |
| `WEBSOCKET_PING_INTERVAL`      | Интервал отправки пингов WebSocket клиентам (секунды).                  | `25`                                   |
| `WEBSOCKET_PING_TIMEOUT`       | Таймаут ожидания понг-ответа от WebSocket клиента (секунды).            | `20`                                   |

## 6. Взаимодействие с другими сервисами

*   **Auth Service**: `WebAPI Service` не взаимодействует напрямую с `Auth Service`. Он полагается на вышестоящий шлюз (например, Traefik или Kong) для аутентификации запросов и передачи информации о пользователе (ID, роль) в заголовках HTTP, которые затем используются для авторизации в самом `WebAPI Service`.
*   **Game Allocator Service**: `WebAPI Service` взаимодействует с `Game Allocator Service` через NATS (событие `game.allocate`) для запроса адреса `Game Service` при создании или присоединении к игре.
*   **Game Service**: Основное взаимодействие происходит через NATS (публикация команд игрока, подписка на обновления состояния игры) и через HTTP-прокси (для запросов, управляющих настройками игры или получением состояния).
*   **NATS**: Используется как основная шина сообщений для реального времени взаимодействия с игровыми сервисами.
*   **Redis**: Используется для кеширования адресов `Game Service` и, возможно, других временных данных.

## 7. Запуск/Развертывание

### 7.1. Локальный запуск (для разработки)

1.  **Установите зависимости**: Убедитесь, что у вас установлен Python 3.12 и UV.
    В директории `services/webapi-service`:
    ```bash
    uv sync
    ```
2.  **Настройте переменные окружения**: Создайте файл `.env` на основе `.env-example` в той же директории и укажите параметры подключения к Redis, NATS, Consul и другие, как описано выше.
3.  **Запустите приложение**: Используйте Uvicorn для запуска с автоматической перезагрузкой.
    ```bash
    uv run uvicorn app.main:app --host 0.0.0.0 --port ${PORT:-5001} --reload
    ```
    Сервис будет доступен по адресу `http://localhost:<PORT>`. API документация (Swagger UI) будет по адресу `http://localhost:<PORT>/docs`.

### 7.2. Сборка и запуск с использованием Docker

1.  **Сборка Docker-образа**: Перейдите в директорию `services/webapi-service` и выполните:
    ```bash
    docker build -t bomberman-webapi-service .
    ```
2.  **Запуск Docker-контейнера**: Запустите контейнер, передав необходимые переменные окружения.
    ```bash
    docker run -p 5001:5001 \\
        -e NATS_URL=nats://<nats_host>:4222 \\
        -e REDIS_HOST=<redis_host> \\
        -e CONSUL_HOST=<consul_host> \\
        bomberman-webapi-service
    ```
    Замените `<nats_host>`, `<redis_host>`, `<consul_host>` на актуальные адреса ваших сервисов.

### 7.3. С использованием Docker Compose (Рекомендуется)

Для комплексного развертывания со всеми зависимыми сервисами рекомендуется использовать корневой `docker-compose.yml` проекта. В нем должны быть настроены соответствующие переменные окружения и зависимости между сервисами.

Пример запуска всех сервисов:
```bash
docker-compose up -d
```
Запуск только `webapi-service` (если определен как сервис):
```bash
docker-compose up -d webapi-service
```

---