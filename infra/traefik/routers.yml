http:
  routers:
    # Traefik Dashboard - должен быть первым для специфичного хоста
    dashboard:
      rule: "Host(`traefik.localhost`)"
      entryPoints:
        - web
      service: api@internal

    # Consul
    consul:
      rule: "Host(`consul.localhost`)"
      entryPoints:
        - web
      service: consul@docker

    # cAdvisoe
    cadvisor:
      rule: "Host(`cadvisor.localhost`)"
      entryPoints:
        - web
      service: cadvisor@docker


    # prometheus
    prometheus:
      rule: "Host(`prometheus.localhost`)"
      entryPoints:
        - web
      service: prometheus@docker

    # Grafana
    grafana:
      rule: "Host(`grafana.localhost`)"
      entryPoints:
        - web
      service: grafana@docker

    # Tensorboard
    tensorboard:
      rule: "Host(`tensorboard.localhost`)"
      entryPoints:
        - web
      service: tensorboard@docker

    # Infisical
    infisical:
      rule: "Host(`infisical.localhost`)"
      entryPoints:
        - web
      service: infisical@docker

    # pgAdmin
    pgadmin:
      rule: "Host(`pgadmin.localhost`)"
      entryPoints:
        - web
      service: pgadmin@docker

    # Web Frontend - должен быть последним, чтобы не перехватывать специфичные маршруты
    frontend:
#      rule: "PathPrefix(`/`)"
      rule: "Host(`bomberman.localhost`)"
      entryPoints:
        - web
      service: web-frontend
      middlewares:
        - compress
        - security-headers

    # Logger API
    logger:
      rule: "Host(`bomberman.localhost`) && PathPrefix(`/logs`)"
      entryPoints:
        - web
      service: logger
      middlewares:
        - strip-logs-prefix

    # WebAPI WebSocket - должен быть перед общим /webapi
    webapi-ws:
      rule: "Host(`bomberman.localhost`) && PathPrefix(`/webapi/socket.io`)"
      entryPoints:
        - web
      service: webapi-service@consulcatalog
      middlewares:
        - extract-cookie-ws_auth_token
        - websocket
        - strip-webapi-prefix
        - auth-check

    # отключаем авторизацию для страниц документаций, для локальной разработки.
    auth-api_docs:
      rule: "Host(`bomberman.localhost`) && PathPrefix(`/auth/docs`)"
      entryPoints:
        - web
      service: auth-service@consulcatalog
      middlewares:
        - compress
        - security-headers

    # Auth сервис - API
    auth-api:
      rule: "Host(`bomberman.localhost`) && PathPrefix(`/auth`)"
      entryPoints:
        - web
      service: auth-service@consulcatalog
      middlewares:
        - compress
        - security-headers

    webapi-docs:
      rule: "Host(`bomberman.localhost`) && PathPrefix(`/webapi/docs`)"
      entryPoints:
        - web
      service: webapi-service@consulcatalog
      middlewares:
        - compress
        - security-headers

    # WebAPI сервис - с проверкой авторизации
    webapi:
      rule: "Host(`bomberman.localhost`) && PathPrefix(`/webapi`)"
      entryPoints:
        - web
      service: webapi-service@consulcatalog
      middlewares:
        - compress
        - security-headers
        - auth-check

    # Game сервис - с проверкой авторизации
    game-docs:
      rule: "Host(`bomberman.localhost`) && PathPrefix(`/games/docs`)"
      entryPoints:
        - web
      service: game-service@consulcatalog
      middlewares:
        - compress
        - security-headers

    # Game сервис rest api - с проверкой авторизации
    game-service-rest:
      rule: "Host(`bomberman.localhost`) && PathPrefix(`/games`)"
      entryPoints:
        - web
      service: game-service@consulcatalog
      middlewares:
        - compress
        - security-headers
        - auth-check

    # Game сервис gRPC - с проверкой авторизации
    game-service-grpc:
      rule: "Host(`bomberman.localhost`) && PathPrefix(`/games/grpc`)"
      entryPoints:
        - web
      service: game-service@consulcatalog
      middlewares:
        - strip-games-grpc-prefix
        - compress
        - security-headers
        - auth-check


    # Ai сервис - с проверкой авторизации
    ai-service-docs:
      rule: "Host(`bomberman.localhost`) && PathPrefix(`/ai-service/docs`)"
      entryPoints:
        - web
      service: ai-service@consulcatalog
      middlewares:
        - compress
        - security-headers

    # Ai сервис - с проверкой авторизации
    ai-service-grpc:
      rule: "Host(`bomberman.localhost`) && PathPrefix(`/ai-service`)"
      entryPoints:
        - web
      service: ai-service@consulcatalog
      middlewares:
        - compress
        - security-headers
#        - auth-check


  services:
    # Fallback сервисы для старта (до регистрации в Consul)
    # Traefik автоматически переключится на Consul Catalog, когда сервисы зарегистрируются
    auth-service:
      loadBalancer:
        servers:
          - url: "http://auth-service:5003"

    webapi-service:
      loadBalancer:
        servers:
          - url: "http://webapi-service:5001"

    game-service-rest:
      loadBalancer:
        servers:
          - url: "http://game-service:5002"

    game-service-grpc:
      loadBalancer:
        servers:
          - url: "h2c://game-service:500051"

    ai-service-rest:
      loadBalancer:
        servers:
          - url: "http://ai-service:5004"

    ai-service-grpc:
      loadBalancer:
        servers:
          - url: "h2c://ai-service:500051"

    # Статические сервисы (не регистрируются в Consul)
    web-frontend:
      loadBalancer:
        servers:
          - url: "http://web-frontend:3000"
          
    logger:
      loadBalancer:
        servers:
          - url: "http://fluent-bit:8888" 