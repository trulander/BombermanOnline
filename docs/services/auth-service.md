# Документация Auth Service

Сервис `Auth Service` является центральным компонентом системы Bomberman Online, отвечающим за управление пользователями, их аутентификацию и авторизацию. Он обеспечивает безопасный доступ к другим сервисам и управляет пользовательскими данными.

## Содержание

- [Назначение Сервиса](#назначение-сервиса)
- [Используемые Технологии](#используемые-технологии)
- [Структура Проекта](#структура-проекта)
- [API Endpoints](#api-endpoints)
  - [Аутентификация](#аутентификация)
  - [Пользователи](#пользователи)
- [Взаимодействие с Другими Сервисами](#взаимодействие-с-другими-сервисами)
- [Переменные Окружения](#переменные-окружения)
- [Запуск и Развертывание](#запуск-и-развертывание)
  - [Через Docker](#через-docker)
  - [Локально](#локально)
- [Управление Миграциями Базы Данных](#управление-миграциями-базы-данных)

---

<a name="назначение-сервиса"></a>
## Назначение Сервиса

Auth Service предоставляет полный набор функций для работы с пользователями:
- **Регистрация и Аутентификация**: Позволяет новым пользователям регистрироваться и существующим входить в систему.
- **Управление JWT Токенами**: Выдача, обновление и аннулирование JSON Web Tokens для обеспечения безопасности сессий.
- **OAuth 2.0 Авторизация**: Интеграция с внешними провайдерами (например, Google) для упрощенной авторизации.
- **Управление Ролями Пользователей**: Поддержка различных ролей (user, admin, moderator, developer) с соответствующими правами доступа.
- **Защита API**: Работает в связке с Traefik Forward Auth для централизованной защиты эндпоинтов.
- **Веб-интерфейс**: Предоставляет страницы для входа, регистрации, сброса пароля и личного кабинета.

<a name="используемые-технологии"></a>
## Используемые Технологии

- **Python 3.12**: Основной язык разработки.
- **FastAPI**: Высокопроизводительный веб-фреймворк для построения API.
- **PostgreSQL**: Реляционная база данных для хранения пользовательских данных, используемая через SQLAlchemy.
- **Redis**: In-memory хранилище данных, используемое для кэширования, хранения сессий и других временных данных, включая списки отозванных JWT токенов (blacklisting).
- **JWT (python-jose)**: Для работы с JSON Web Tokens.
- **OAuth 2.0**: Для федеративной аутентификации.
- **Jinja2 Templates**: Для рендеринга веб-страниц.
- **Alembic**: Инструмент для управления миграциями базы данных.
- **uv**: Менеджер пакетов и зависимостей Python.

<a name="структура-проекта"></a>
## Структура Проекта

```
auth-service/
├── app/
│   ├── models/           # Модели данных (Pydantic и SQLAlchemy ORM)
│   ├── routes/           # Маршруты API и веб-интерфейса, разделенные по логическим блокам
│   ├── services/         # Бизнес-логика, инкапсулирующая операции (например, Auth Service, User Service, OAuth Service, Token Service)
│   ├── templates/        # HTML шаблоны для веб-интерфейса
│   ├── static/           # Статические файлы (CSS, JS, изображения) для веб-интерфейса
│   ├── config.py         # Конфигурационные настройки приложения
│   ├── database.py       # Инициализация подключения к базе данных SQLAlchemy
│   ├── dependencies.py   # Зависимости FastAPI, такие как получение текущего пользователя, проверка ролей
│   ├── error_handlers.py # Кастомные обработчики ошибок для FastAPI
│   ├── logging_config.py # Настройка логирования приложения
│   ├── main.py           # Основной файл приложения FastAPI, точка входа
│   ├── redis_client.py   # Клиент для взаимодействия с Redis
│   ├── alembic/          # Директория для Alembic миграций
│   └── manage.py         # Скрипт для управления миграциями и другими задачами
├── alembic.ini           # Конфигурация Alembic для миграций базы данных
├── docker-entrypoint.sh  # Скрипт запуска контейнера Docker
├── Dockerfile            # Определение образа Docker
├── pyproject.toml        # Управление зависимостями проекта с помощью Poetry или uv
├── README.md             # Краткое описание сервиса
└── uv.lock               # Файл блокировки зависимостей uv
```

<a name="api-endpoints"></a>
## API Endpoints

Все API эндпоинты доступны через базовый путь `/api/v1/`.

### Общие эндпоинты

- `GET /health`
  - **Описание**: Маршрут для проверки работоспособности сервиса. Возвращает статус `healthy`.
  - **Ответ**: `{"status": "healthy", "service": "auth-service"}`.
- `GET /ping`
  - **Описание**: Простой пинг для проверки доступности сервиса. Возвращает `pong`.
  - **Ответ**: `pong` (text/plain).

### Аутентификация

- `POST /auth/login`
  - **Описание**: Аутентификация пользователя, выдача access и refresh токенов.
  - **Запрос**: `username`, `password`.
  - **Ответ**: `access_token`, `refresh_token`, `token_type`, `expires_in`.
- `POST /auth/refresh`
  - **Описание**: Обновление access токена с использованием refresh токена.
  - **Запрос**: `refresh_token` (обычно из куки).
  - **Ответ**: Новый `access_token` и `refresh_token`.
- `POST /auth/logout`
  - **Описание**: Выход пользователя из системы, аннулирование refresh токена.
  - **Запрос**: (пусто)
  - **Ответ**: Сообщение об успехе.
- `GET /auth/check`
  - **Описание**: Проверка валидности access токена. Используется Traefik Forward Auth.
  - **Запрос**: (access токен в заголовке `Authorization` или куке `ws_auth_token`)
  - **Ответ**: HTTP 200 OK, если токен валиден; HTTP 401 Unauthorized, если нет.
- `POST /auth/reset-password`
  - **Описание**: Запрос на сброс пароля. Отправляет ссылку для сброса на email пользователя.
  - **Запрос**: `email`.
  - **Ответ**: Сообщение об успехе.
- `POST /auth/confirm-reset-password`
  - **Описание**: Подтверждение сброса пароля с использованием токена из email и установка нового пароля.
  - **Запрос**: `token`, `new_password`.
  - **Ответ**: Сообщение об успехе.
- `GET /auth/verify-email`
  - **Описание**: Подтверждение email пользователя по токену из письма.
  - **Запрос**: `token` (из URL).
  - **Ответ**: Перенаправление на страницу входа или сообщение об успехе/ошибке.
- `GET /auth/oauth/{provider}`
  - **Описание**: Начало процесса OAuth 2.0 авторизации через внешнего провайдера (например, `google`).
  - **Параметры пути**: `provider` (например, `google`).
  - **Ответ**: Перенаправление на страницу авторизации провайдера.
- `GET /auth/oauth/{provider}/callback`
  - **Описание**: Callback URL для OAuth 2.0 после успешной авторизации у провайдера.
  - **Параметры пути**: `provider`.
  - **Параметры запроса**: Код авторизации.
  - **Ответ**: Установка токенов и перенаправление пользователя.

<a name="пользователи"></a>
### Пользователи

- `POST /users`
  - **Описание**: Регистрация нового пользователя.
  - **Запрос**: `username`, `email`, `password`, `full_name` (опционально).
  - **Ответ**: Данные созданного пользователя.
- `GET /users/me`
  - **Описание**: Получение информации о текущем аутентифицированном пользователе.
  - **Запрос**: (требуется авторизация)
  - **Ответ**: Данные текущего пользователя.
- `PUT /users/me`
  - **Описание**: Обновление информации о текущем аутентифицированном пользователе.
  - **Запрос**: (частичные данные пользователя, требуется авторизация)
  - **Ответ**: Обновленные данные пользователя.
- `GET /users/{user_id}`
  - **Описание**: Получение информации о пользователе по его ID.
  - **Параметры пути**: `user_id`.
  - **Запрос**: (требуется авторизация, возможно, с определенной ролью)
  - **Ответ**: Данные пользователя.
- `PUT /users/{user_id}/role`
  - **Описание**: Обновление роли пользователя. Только для администраторов.
  - **Параметры пути**: `user_id`.
  - **Запрос**: `role` (новая роль, требуется авторизация с ролью `admin`).
  - **Ответ**: Обновленные данные пользователя.
- `GET /users`
  - **Описание**: Поиск и получение списка пользователей. Может быть использован для администрирования.
  - **Запрос**: (опциональные параметры фильтрации/пагинации, требуется авторизация с определенной ролью).
  - **Ответ**: Список пользователей.

## Маршруты пользовательского интерфейса (UI Routes)

Эти маршруты обслуживают веб-страницы для взаимодействия с пользователем. Все они доступны через базовый путь `/ui/`.

- `GET /ui/login`
  - **Описание**: Страница входа в систему. Если пользователь уже аутентифицирован, перенаправляет на `/ui/dashboard`.
- `GET /ui/register`
  - **Описание**: Страница регистрации нового пользователя. Если пользователь уже аутентифицирован, перенаправляет на `/ui/dashboard`.
- `GET /ui/reset-password`
  - **Описание**: Страница запроса сброса пароля. Если пользователь уже аутентифицирован, перенаправляет на `/ui/dashboard`.
- `GET /ui/confirm-reset-password`
  - **Описание**: Страница подтверждения сброса пароля. Требует токен сброса. Если пользователь уже аутентифицирован, перенаправляет на `/ui/dashboard`.
- `GET /ui/verify-email`
  - **Описание**: Страница подтверждения электронной почты. Требует токен подтверждения.
- `GET /ui/dashboard`
  - **Описание**: Личный кабинет пользователя. Требует аутентификации. Если пользователь не аутентифицирован, перенаправляет на `/ui/login`.
- `GET /ui/profile`
  - **Описание**: Страница профиля пользователя. Требует аутентификации. Если пользователь не аутентифицирован, перенаправляет на `/ui/login`.
- `GET /ui`
  - **Описание**: Корневой маршрут UI. Перенаправляет на `/ui/login`.

<a name="взаимодействие-с-другими-сервисами"></a>
## Взаимодействие с Другими Сервисами

Auth Service является краеугольным камнем для аутентификации во всей системе Bomberman Online. Он взаимодействует со следующими компонентами:

- **PostgreSQL**: Основное хранилище для пользовательских данных, таких как учетные записи, профили и роли. Взаимодействие происходит через SQLAlchemy ORM.
- **Redis**: Используется для:
    - **Кэширования**: Ускорение доступа к часто запрашиваемым данным.
    - **Хранения токенов**: Управление сессиями и списки отозванных JWT токенов (blacklisting) для повышения безопасности.
    - **Временных данных**: Хранение кодов подтверждения email и токенов сброса пароля.
- **Traefik**: Как упомянуто в `infra/docker-compose.yml` и `services/auth-service/README.md`, Traefik использует `auth-service` через Traefik Forward Auth для аутентификации запросов к другим микросервисам и веб-фронтенду. Это позволяет централизовать логику авторизации.

<a name="переменные-окружения"></a>
## Переменные Окружения

Конфигурация сервиса осуществляется через следующие переменные окружения. Значения по умолчанию указаны, если не заданы в файле `.env` или окружении.

| Переменная                     | Описание                                                                 | Значение по умолчанию (`app/config.py`) |
| :----------------------------- | :----------------------------------------------------------------------- | :------------------------------------- |
| `API_V1_STR`                   | Префикс URL для всех API эндпоинтов V1.                                  | `/auth/api/v1`                         |
| `APP_TITLE`                    | Заголовок приложения (для Swagger).
| `HOST`                         | Хост, на котором запускается FastAPI приложение.                         | `0.0.0.0`                              |
| `PORT`                         | Порт, на котором запускается FastAPI приложение.                         | `5003`                                 |
| `DEBUG`                        | Включает режим отладки FastAPI.                                          | `True`                                 |
| `RELOAD`                       | Включает автоматическую перезагрузку Uvicorn при изменениях кода.        | `True`                                 |
| `SWAGGER_URL`                  | URL для доступа к Swagger UI документации.                               | `/auth/docs`                           |
| `SERVICE_NAME`                 | Имя сервиса (для логирования).                                           | `auth-service`                         |
| `CONSUL_HOST`                  | Хост Consul для обнаружения сервисов.                                    | `localhost`                            |
| `CORS_ORIGINS`                 | Список разрешенных источников для CORS (через запятую или JSON список).  | `["*"]` (все источники)              |
| `CORS_CREDENTIALS`             | Разрешает ли CORS передачу credentials (например, cookie).               | `True`                                 |
| `CORS_METHODS`                 | Список разрешенных HTTP методов для CORS.                                | `["*"]` (все методы)                 |
| `CORS_HEADERS`                 | Список разрешенных HTTP заголовков для CORS.                             | `["*"]` (все заголовки)              |
| `REDIS_HOST`                   | Хост для подключения к Redis.                                            | `localhost`                            |
| `REDIS_PORT`                   | Порт для подключения к Redis.                                            | `6379`                                 |
| `REDIS_DB`                     | Номер базы данных Redis.                                                 | `1`                                    |
| `REDIS_PASSWORD`               | Пароль для подключения к Redis (если требуется).                         | `None`                                 |
| `POSTGRES_HOST`                | Хост для подключения к базе данных PostgreSQL.                           | `localhost`                            |
| `POSTGRES_PORT`                | Порт для подключения к PostgreSQL.                                       | `5432`                                 |
| `POSTGRES_DB`                  | Имя базы данных PostgreSQL для сервиса аутентификации.                   | `auth_service`                         |
| `POSTGRES_USER`                | Имя пользователя для подключения к PostgreSQL.                           | `bomberman`                            |
| `POSTGRES_PASSWORD`            | Пароль пользователя для подключения к PostgreSQL.                        | `bomberman`                            |
| `SECRET_KEY`                   | **Обязательный** секретный ключ для подписи JWT токенов. Должен быть длинной, случайной строкой. | `your_secret_key_here`                 |
| `ALGORITHM`                    | Алгоритм шифрования для JWT токенов.                                     | `HS256`                                |
| `ACCESS_TOKEN_EXPIRE_MINUTES`  | Время жизни Access Token в минутах.                                      | `3000`                                 |
| `REFRESH_TOKEN_EXPIRE_DAYS`    | Время жизни Refresh Token в днях.                                        | `7`                                    |
| `OAUTH2_PROVIDERS`             | Конфигурация для OAuth2 провайдеров. Включает `client_id`, `client_secret`, эндпоинты и scope. | (Внутренний словарь, см. `config.py`) |
| `TEMPLATES_DIR`                | Путь к директории с HTML-шаблонами.                                      | `app/templates`                        |
| `ROLES`                        | Список доступных ролей пользователей.                                    | `["user", "admin", "moderator", "developer"]` |
| `LOG_LEVEL`                    | Уровень логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL).             | `DEBUG`                                |
| `LOG_FORMAT`                   | Формат логов (`text` или `json`).                                        | `json`                                 |
| `TRACE_CALLER`                 | Включает ли добавление информации о вызывающих функциях в JSON логи.     | `True`                                 |

<a name="запуск-и-развертывание"></a>
## Запуск и Развертывание

### Через Docker

Для сборки образа Docker и запуска контейнера:

```bash
docker build -t auth-service .
docker run -p 5003:5003 auth-service
```

В production-среде рекомендуется использовать `docker-compose.yml` для управления всеми сервисами.

### Локально

Для локальной разработки:

1.  **Установка зависимостей** (используя `uv`):
    ```bash
    cd services/auth-service
    uv pip install -e .
    ```

2.  **Запуск приложения**:
    ```bash
    uvicorn app.main:app --host 0.0.0.0 --port 5003 --reload
    ```

<a name="управление-миграциями-базы-данных"></a>
## Управление Миграциями Базы Данных

Auth Service использует Alembic для управления миграциями базы данных PostgreSQL.

### Создание новой миграции

Автоматическое создание миграции на основе изменений в моделях:

```bash
python scripts/create_migration.py "Название миграции"
# или напрямую через Alembic
alembic revision --autogenerate -m "Название миграции"
```

### Применение миграций

Применение всех миграций до последней версии:

```bash
python scripts/apply_migrations.py
# или напрямую через Alembic
alembic upgrade head
```

Применение миграций до определенной версии:

```bash
python scripts/apply_migrations.py <revision>
alembic upgrade <revision>
```

Применение следующей миграции:

```bash
alembic upgrade +1
```

### Откат миграций

Откат на одну миграцию назад:

```bash
python scripts/rollback_migrations.py
# или напрямую через Alembic
alembic downgrade -1
```

Откат до определенной версии:

```bash
python scripts/rollback_migrations.py <revision>
alembic downgrade <revision>
```

Откат всех миграций:

```bash
python scripts/rollback_migrations.py base
alembic downgrade base
```

### Просмотр истории миграций

Просмотр истории миграций и текущей ревизии:

```bash
python scripts/show_migrations.py
# или напрямую через Alembic
alembic history --verbose
alembic current
```
