# Loki и Fluent Bit
[![English](https://img.shields.io/badge/lang-English-blue.svg)](../../../en/infra/loki-fluent-bit/index.md)

## Назначение в проекте

**Loki** и **Fluent Bit** вместе образуют систему централизованного сбора и хранения логов.

-   **Fluent Bit**: Выступает в роли легковесного **агента-сборщика логов**. Он собирает логи из различных источников, парсит их, обогащает метаданными и пересылает в хранилище.
-   **Loki**: Является **хранилищем логов**. В отличие от традиционных систем, Loki индексирует только метаданные (лейблы), а не полный текст сообщений, что делает его очень быстрым и экономичным.

## Конфигурация Fluent Bit

Конфигурация находится в `infra/fluent-bit/`:

-   **`fluent-bit.conf`**: Основной файл, определяющий конвейер обработки логов.
-   **`parsers.conf`**: Определяет правила парсинга для разных форматов логов.

### Источники логов (`fluent-bit.conf`)

1.  **Docker-контейнеры**:
    -   `[INPUT]` с `Name` = `forward` принимает логи от Docker-демона по порту `24224`.
    -   Логи парсятся как JSON (`Parser json`).
    -   `[OUTPUT]` отправляет эти логи в Loki с лейблом `job=docker` и динамическим лейблом, содержащим имя контейнера (`Label_Keys $container_name`).

2.  **Frontend-приложение**:
    -   `[INPUT]` с `Name` = `http` принимает логи от `web-frontend` по порту `8888`.
    -   `[Filter]` с `Name` = `lua` используется для обработки пакетов логов.
    -   `[OUTPUT]` отправляет эти логи в Loki с лейблами `job=web-frontend` и `component=frontend`.

## Конфигурация Loki

Конфигурация находится в `infra/loki/loki-config.yml`.

-   **`auth_enabled: false`**: Аутентификация отключена.
-   **`server.http_listen_port: 3100`**: Loki принимает запросы на этот порт.
-   **`storage_config`**: Настроено хранение индексов и чанков логов на файловой системе (`filesystem`) внутри Docker-тома `loki_data`.
-   **`schema_config`**: Используется схема `v13` с хранилищем `tsdb`.

## Взаимодействие

1.  Все микросервисы, запущенные через `docker-compose`, настроены на использование `fluentd` в качестве log-драйвера, который отправляет их логи на порт `24224`.
2.  `fluent-bit` принимает эти логи, а также логи от фронтенда по HTTP.
3.  `fluent-bit` обрабатывает и отправляет все логи в `Loki`.
4.  `Grafana` подключена к `Loki` как к источнику данных и используется для визуализации, поиска и анализа логов.
